@model AutonomousMarketingPlatform.Application.DTOs.N8nConfigDto
@{
    ViewData["Title"] = "Configuración de n8n";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-plug mr-2"></i>@ViewData["Title"]</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item active">@ViewData["Title"]</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-check"></i> @TempData["SuccessMessage"]
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <i class="icon fas fa-ban"></i> @TempData["ErrorMessage"]
            </div>
        }

        <div class="row">
            @if (ViewBag.IsSuperAdmin == true)
            {
                <div class="col-12 mb-3">
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-building mr-2"></i>Seleccionar Tenant
                            </h3>
                        </div>
                        <div class="card-body">
                            <form method="get" asp-action="Index">
                                <div class="form-group">
                                    <label for="tenantId">Tenant</label>
                                    <select class="form-control" id="tenantId" name="tenantId" onchange="this.form.submit()">
                                        @if (ViewBag.Tenants != null)
                                        {
                                            foreach (var tenant in (List<AutonomousMarketingPlatform.Application.DTOs.TenantDto>)ViewBag.Tenants)
                                            {
                                                var isSelected = ViewBag.SelectedTenantId != null && ((Guid)ViewBag.SelectedTenantId) == tenant.Id;
                                                <option value="@tenant.Id" selected="@isSelected">@tenant.Name (@tenant.Subdomain)</option>
                                            }
                                        }
                                    </select>
                                    <small class="form-text text-muted">
                                        Como SuperAdmin, puedes configurar n8n para cualquier tenant.
                                    </small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Configuración General -->
            <div class="col-md-6">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cog mr-2"></i>Configuración General
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="n8nConfigForm" method="post" asp-action="Save">
                            @Html.AntiForgeryToken()
                            @if (ViewBag.IsSuperAdmin == true && ViewBag.SelectedTenantId != null)
                            {
                                <input type="hidden" name="tenantId" value="@ViewBag.SelectedTenantId" />
                            }

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="UseMock" name="UseMock" 
                                           value="true" @(Model.UseMock ? "checked" : "")>
                                    <label class="form-check-label" for="UseMock">
                                        <strong>Usar Modo Mock (Simulación)</strong>
                                    </label>
                                    <small class="form-text text-muted">
                                        Si está activado, el sistema simulará las llamadas a n8n sin conectarse realmente.
                                    </small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="BaseUrl">URL Base de n8n</label>
                                <input type="url" class="form-control" id="BaseUrl" name="BaseUrl" 
                                       value="@Model.BaseUrl" placeholder="http://localhost:5678" required>
                                <small class="form-text text-muted">
                                    URL donde está corriendo n8n (ej: http://localhost:5678)
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="ApiUrl">URL de API de n8n</label>
                                <input type="url" class="form-control" id="ApiUrl" name="ApiUrl" 
                                       value="@Model.ApiUrl" placeholder="http://localhost:5678/api/v1" required>
                            </div>

                            <div class="form-group">
                                <label for="ApiKey">API Key (Opcional)</label>
                                <input type="password" class="form-control" id="ApiKey" name="ApiKey" 
                                       value="@Model.ApiKey" placeholder="API Key de n8n (si aplica)">
                                <small class="form-text text-muted">
                                    API Key para autenticación con n8n (opcional)
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="DefaultWebhookUrl">URL por Defecto de Webhooks</label>
                                <input type="url" class="form-control" id="DefaultWebhookUrl" name="DefaultWebhookUrl" 
                                       value="@Model.DefaultWebhookUrl" placeholder="http://localhost:5678/webhook">
                            </div>

                            <div class="form-group">
                                <label for="testCampaignId">
                                    <i class="fas fa-bullhorn mr-1"></i>Campaign ID (Opcional - usar datos reales de la campaña):
                                </label>
                                <input type="text" class="form-control" id="testCampaignId" 
                                       placeholder="Ej: 73f24df7-644a-4895-865b-0a507926b97e" 
                                       style="max-width: 400px;">
                                <small class="form-text text-muted">
                                    <strong>Si ingresas un Campaign ID:</strong> El sistema cargará automáticamente los datos reales de la campaña 
                                    (nombre, descripción, objetivos, audiencia objetivo, canales) y los usará para construir la instrucción del webhook. 
                                    <br><strong>Si dejas vacío:</strong> Se enviará una instrucción de prueba genérica.
                                </small>
                            </div>

                            <div class="form-group">
                                <button type="button" class="btn btn-info" id="testConnectionBtn">
                                    <i class="fas fa-network-wired mr-2"></i>Probar Conexión
                                </button>
                                <button type="button" class="btn btn-success" id="testWebhookBtn">
                                    <i class="fas fa-paper-plane mr-2"></i>Probar Webhook Marketing Request
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save mr-2"></i>Guardar Configuración
                                </button>
                            </div>
                        </form>

                        <!-- Resultado de prueba de conexión -->
                        <div id="connectionTestResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- URLs de Webhooks -->
            <div class="col-md-6">
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-link mr-2"></i>URLs de Webhooks
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Configura las URLs de los webhooks de cada workflow de n8n.
                            Copia las URLs desde n8n después de importar y activar los workflows.
                        </p>

                        <form id="webhooksForm" method="post" asp-action="Save">
                            @Html.AntiForgeryToken()
                            @if (ViewBag.IsSuperAdmin == true && ViewBag.SelectedTenantId != null)
                            {
                                <input type="hidden" name="tenantId" value="@ViewBag.SelectedTenantId" />
                            }
                            <input type="hidden" name="UseMock" value="@Model.UseMock.ToString().ToLower()" />
                            <input type="hidden" name="BaseUrl" value="@Model.BaseUrl" />
                            <input type="hidden" name="ApiUrl" value="@Model.ApiUrl" />
                            <input type="hidden" name="ApiKey" value="@Model.ApiKey" />
                            <input type="hidden" name="DefaultWebhookUrl" value="@Model.DefaultWebhookUrl" />

                            @{
                                var webhookNames = new Dictionary<string, string>
                                {
                                    { "MarketingRequest", "Trigger - Marketing Request" },
                                    { "ValidateConsents", "Validate Consents" },
                                    { "LoadMemory", "Load Marketing Memory" },
                                    { "AnalyzeInstruction", "Analyze Instruction AI" },
                                    { "GenerateStrategy", "Generate Marketing Strategy" },
                                    { "GenerateCopy", "Generate Marketing Copy" },
                                    { "GenerateVisualPrompts", "Generate Visual Prompts" },
                                    { "BuildMarketingPack", "Build Marketing Pack" },
                                    { "HumanApproval", "Human Approval Flow" },
                                    { "PublishContent", "Publish Content" },
                                    { "MetricsLearning", "Metrics & Learning" }
                                };
                            }

                            @foreach (var webhook in webhookNames)
                            {
                                var webhookKey = $"WebhookUrls[{webhook.Key}]";
                                var currentValue = Model.WebhookUrls.ContainsKey(webhook.Key) 
                                    ? Model.WebhookUrls[webhook.Key] 
                                    : "";

                                <div class="form-group">
                                    <label for="@webhook.Key">@webhook.Value</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="@webhook.Key" 
                                               name="@webhookKey" value="@currentValue" 
                                               placeholder="http://localhost:5678/webhook/...">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-secondary test-webhook-btn" 
                                                    data-webhook="@webhook.Key" data-url="@currentValue">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        Event Type: <code>@webhook.Key.ToLower().Replace("request", "request").Replace("consents", "consents")</code>
                                    </small>
                                </div>
                            }

                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save mr-2"></i>Guardar URLs de Webhooks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información de Workflows -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-project-diagram mr-2"></i>Workflows Disponibles
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Lista de workflows de n8n que deben ser importados y configurados.
                        </p>
                        <div id="workflowsList" class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Event Type</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="workflowsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Cargar información de workflows
            loadWorkflowsInfo();

            // Probar conexión con n8n
            $('#testConnectionBtn').on('click', function() {
                testConnection();
            });

            // Probar webhook de marketing request
            $('#testWebhookBtn').on('click', function() {
                testWebhook();
            });

            // Probar webhook individual
            $('.test-webhook-btn').on('click', function() {
                var webhookKey = $(this).data('webhook');
                var webhookUrl = $(this).data('url');
                if (webhookUrl) {
                    testWebhook(webhookKey, webhookUrl);
                } else {
                    alert('Por favor, ingresa una URL primero');
                }
            });
        });

        function loadWorkflowsInfo() {
            $.get('/N8nConfig/GetWorkflowsInfo')
                .done(function(workflows) {
                    var tbody = $('#workflowsTableBody');
                    tbody.empty();

                    workflows.forEach(function(workflow) {
                        var statusBadge = getStatusBadge(workflow.status);
                        var row = `
                            <tr>
                                <td><strong>${workflow.name}</strong></td>
                                <td>${workflow.description}</td>
                                <td><code>${workflow.eventType}</code></td>
                                <td>${statusBadge}</td>
                                <td>
                                    ${workflow.webhookUrl ? 
                                        `<a href="${workflow.webhookUrl}" target="_blank" class="btn btn-sm btn-info">
                                            <i class="fas fa-external-link-alt"></i> Abrir
                                        </a>` : 
                                        '<span class="text-muted">No configurado</span>'
                                    }
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                })
                .fail(function() {
                    $('#workflowsTableBody').html(`
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error al cargar workflows
                            </td>
                        </tr>
                    `);
                });
        }

        function getStatusBadge(status) {
            var badges = {
                'Active': '<span class="badge badge-success">Activo</span>',
                'Inactive': '<span class="badge badge-secondary">Inactivo</span>',
                'Error': '<span class="badge badge-danger">Error</span>',
                'Unknown': '<span class="badge badge-warning">Desconocido</span>'
            };
            return badges[status] || badges['Unknown'];
        }

        function testConnection() {
            var baseUrl = $('#BaseUrl').val();
            var apiKey = $('#ApiKey').val();

            // Si no hay baseUrl en el formulario, usar la configuración de la BD (enviar null)
            var requestData = null;
            if (baseUrl) {
                requestData = {
                    baseUrl: baseUrl,
                    apiKey: apiKey || null
                };
            }

            var $btn = $('#testConnectionBtn');
            showButtonLoading($btn, '<i class="fas fa-spinner fa-spin mr-2"></i>Probando...');

            $.ajax({
                url: '/N8nConfig/TestConnection',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    var resultDiv = $('#connectionTestResult');
                    resultDiv.show();

                    if (response.success) {
                        resultDiv.html(`
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>¡Conexión exitosa!</strong><br>
                                ${response.message}
                            </div>
                        `);
                    } else {
                        resultDiv.html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle mr-2"></i>
                                <strong>Error de conexión</strong><br>
                                ${response.message}
                                ${response.error ? '<br><small>' + response.error + '</small>' : ''}
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('#connectionTestResult').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle mr-2"></i>
                            <strong>Error</strong><br>
                            No se pudo probar la conexión. Verifica que n8n esté corriendo.
                        </div>
                    `).show();
                },
                complete: function() {
                    hideButtonLoading($btn);
                }
            });
        }

        function testWebhook(webhookKey, webhookUrl) {
            // Aquí podrías implementar una prueba del webhook
            alert('Prueba de webhook: ' + webhookKey + '\nURL: ' + webhookUrl);
        }

        function testWebhook() {
            var $btn = $('#testWebhookBtn');
            showButtonLoading($btn, '<i class="fas fa-spinner fa-spin mr-2"></i>Probando...');

            // Obtener tenantId seleccionado si es SuperAdmin
            var selectedTenantId = '@(ViewBag.SelectedTenantId != null ? ViewBag.SelectedTenantId.ToString() : "")';
            var isSuperAdmin = @(ViewBag.IsSuperAdmin == true ? "true" : "false");
            
            // Obtener campaignId del campo de entrada (opcional)
            var campaignIdInput = $('#testCampaignId').val().trim();
            var hasCampaignId = false;

            var requestData = {
                requiresApproval: false,
                assets: []
            };

            // Si es SuperAdmin y hay un tenantId seleccionado, incluirlo en el request
            if (isSuperAdmin && selectedTenantId && selectedTenantId !== '') {
                requestData.tenantId = selectedTenantId;
            }
            
            // Si hay un campaignId ingresado, validarlo y agregarlo
            // NO enviar instruction ni channels - el backend los generará desde los datos reales de la campaña
            if (campaignIdInput && campaignIdInput !== '') {
                // Validar formato GUID básico
                var guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (guidRegex.test(campaignIdInput)) {
                    requestData.campaignId = campaignIdInput;
                    hasCampaignId = true;
                    // NO incluir instruction ni channels - el backend los generará desde la campaña
                } else {
                    alert('El Campaign ID no tiene un formato válido (GUID). Se enviará sin campaignId.');
                }
            }
            
            // Solo agregar instruction y channels si NO hay campaignId (valores por defecto para prueba sin campaña)
            if (!hasCampaignId) {
                requestData.instruction = 'Prueba de webhook desde el frontend - Crear contenido de marketing para Instagram';
                requestData.channels = ['instagram'];
            }

            $.ajax({
                url: '/N8nConfig/TestWebhook',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    var resultDiv = $('#connectionTestResult');
                    resultDiv.show();

                    if (response.success) {
                        var realDataBadge = response.usingRealData 
                            ? '<span class="badge badge-success ml-2"><i class="fas fa-check"></i> Usando datos reales de la campaña</span>'
                            : '';
                        var instructionInfo = response.instruction 
                            ? `<br><strong>Instrucción enviada:</strong><br><small class="text-muted">${response.instruction}</small>`
                            : '';
                        var channelsInfo = response.channels && response.channels.length > 0
                            ? `<br><strong>Canales:</strong> ${response.channels.join(', ')}`
                            : '';
                        
                        resultDiv.html(`
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>¡Webhook disparado exitosamente!</strong>${realDataBadge}<br>
                                ${response.message}<br>
                                <small>Request ID: ${response.requestId}</small>
                                ${instructionInfo}
                                ${channelsInfo}
                            </div>
                        `);
                    } else {
                        resultDiv.html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle mr-2"></i>
                                <strong>Error al disparar webhook</strong><br>
                                ${response.message}
                                ${response.error ? '<br><small>' + response.error + '</small>' : ''}
                            </div>
                        `);
                    }
                },
                error: function(xhr) {
                    $('#connectionTestResult').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle mr-2"></i>
                            <strong>Error</strong><br>
                            No se pudo disparar el webhook. Verifica la configuración y que n8n esté corriendo.
                            ${xhr.responseJSON ? '<br><small>' + JSON.stringify(xhr.responseJSON) + '</small>' : ''}
                        </div>
                    `).show();
                },
                complete: function() {
                    hideButtonLoading($btn);
                }
            });
        }
    </script>
}

