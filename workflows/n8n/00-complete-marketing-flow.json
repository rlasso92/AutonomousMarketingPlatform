{
    "name":  "Complete Marketing Flow - Integrated",
    "nodes":  [
    {
                      "parameters":  {
                                         "httpMethod":  "POST",
                                         "path":  "marketing-request",
                                         "responseMode":  "responseNode",
                                         "options":  {

                                                     }
      },
                      "id":  "webhook-trigger",
                      "name":  "Webhook - Receive Request",
                      "type":  "n8n-nodes-base.webhook",
                      "typeVersion":  2,
                      "position":  [
                                       250,
                                       300
                                   ],
                      "webhookId":  "complete-marketing-flow-webhook"
    },
    {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
            {
                                                                                     "name":  "tenantId",
                                                                                     "value":  "={{ $json.body?.body?.tenantId ?? $json.body?.tenantId ?? $json.tenantId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "userId",
                                                                                     "value":  "={{ $json.body?.body?.userId ?? $json.body?.userId ?? $json.userId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "instruction",
                                                                                     "value":  "={{ $json.body?.body?.instruction ?? $json.body?.instruction ?? $json.instruction }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "campaignId",
                                                                                     "value":  "={{ $json.body?.body?.campaignId ?? $json.body?.campaignId ?? $json.campaignId ?? null }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "requiresApproval",
                                                                                     "value":  "={{ Boolean($json.body?.body?.requiresApproval ?? $json.body?.requiresApproval ?? $json.requiresApproval ?? false) }}",
                                                                                     "type":  "boolean"
            },
            {
                                                                                     "name":  "channelsNormalized",
                                                                                     "value":  "={{ (() => { const ch = $json.body?.body?.channels ?? $json.body?.channels ?? $json.channels ?? []; return Array.isArray(ch) ? ch : (ch ? [ch] : []); })() }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "assets",
                                                                                     "value":  "={{ (() => { const a = $json.body?.body?.assets ?? $json.body?.assets ?? $json.assets ?? []; return Array.isArray(a) ? a : (a ? [a] : []); })() }}",
                                                                                     "type":  "array"
            }
          ]
        },
                                         "options":  {

                                                     }
      },
                      "id":  "normalize-payload",
                      "name":  "Normalize Payload",
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3,
                      "position":  [
                                       450,
                                       300
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "combinator":  "and",
                                                            "options":  {
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.tenantId }}",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "notEmpty"
              }
            },
            {
                                                                                   "leftValue":  "={{ $json.userId }}",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "notEmpty"
              }
            },
            {
                                                                                   "leftValue":  "={{ $json.instruction }}",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "notEmpty"
              }
            },
            {
                                                                                   "leftValue":  "={{ Number($json.channelsNormalized.length) }}",
                                                                                   "rightValue":  0,
                                                                                   "operator":  {
                                                                                                    "type":  "number",
                                                                                                    "operation":  "larger"
              }
            }
          ]
        },
                                         "options":  {

                                                     }
      },
                      "id":  "validate-fields",
                      "name":  "Validate Required Fields",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       650,
                                       300
                                   ]
    },
    {
                      "parameters":  {
                                         "respondWith":  "json",
                                         "responseBody":  "={{ { success: false, error: \u0027Missing required fields\u0027, message: \u0027The request must include: tenantId, userId, instruction, channels, and requiresApproval\u0027 } }}",
                                         "options":  {
                                                         "responseCode":  400
        }
      },
                      "id":  "respond-validation-error",
                      "name":  "Respond - Validation Error",
                      "type":  "n8n-nodes-base.respondToWebhook",
                      "typeVersion":  1,
                      "position":  [
                                       850,
                                       200
                                   ]
    },
    {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
            {
                                                                                     "name":  "tenantId",
                                                                                     "value":  "={{ $json.tenantId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "userId",
                                                                                     "value":  "={{ $json.userId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "campaignId",
                                                                                     "value":  "={{ $json.campaignId ?? null }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "instruction",
                                                                                     "value":  "={{ $json.instruction }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "channels",
                                                                                     "value":  "={{ $json.channelsNormalized }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "assets",
                                                                                     "value":  "={{ $json.assets }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "requiresApproval",
                                                                                     "value":  "={{ $json.requiresApproval }}",
                                                                                     "type":  "boolean"
            },
            {
                                                                                     "name":  "validatedData",
                                                                                     "value":  "={{ { tenantId: $json.tenantId, userId: $json.userId, campaignId: $json.campaignId ?? null, instruction: $json.instruction, channels: $json.channelsNormalized, assets: $json.assets, requiresApproval: $json.requiresApproval, receivedAt: $now, requestId: $execution.id } }}",
                                                                                     "type":  "object"
            }
          ]
        },
                                         "options":  {

                                                     }
      },
                      "id":  "set-validated-data",
                      "name":  "Set Validated Data",
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3,
                      "position":  [
                                       1050,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "name":  "cognitiveEngineVersion",
                                                                                     "value":  "v1.0-cognitive-engine",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "enginePhase",
                                                                                     "value":  "production",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "engineType",
                                                                                     "value":  "monolithic",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "tenantId",
                                                                                     "value":  "={{ $json.tenantId }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "userId",
                                                                                     "value":  "={{ $json.userId }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "campaignId",
                                                                                     "value":  "={{ $json.campaignId ?? null }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "instruction",
                                                                                     "value":  "={{ $json.instruction }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "name":  "channels",
                                                                                     "value":  "={{ $json.channels }}",
                                                                                     "type":  "array"
                                                                                 },
                                                                                 {
                                                                                     "name":  "assets",
                                                                                     "value":  "={{ $json.assets }}",
                                                                                     "type":  "array"
                                                                                 },
                                                                                 {
                                                                                     "name":  "requiresApproval",
                                                                                     "value":  "={{ $json.requiresApproval }}",
                                                                                     "type":  "boolean"
                                                                                 },
                                                                                 {
                                                                                     "name":  "validatedData",
                                                                                     "value":  "={{ $json.validatedData }}",
                                                                                     "type":  "object"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {

                                                     }
                                     },
                      "id":  "set-cognitive-engine-version",
                      "name":  "Set Cognitive Engine Version",
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3,
                      "position":  [
                                       1150,
                                       400
                                   ]
                  },
                  {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/ConsentsApi/check",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId ?? $('Set Cognitive Engine Version').item.json.tenantId }}"
            },
            {
                                                                                        "name":  "userId",
                                                                                        "value":  "={{ $json.userId ?? $('Set Cognitive Engine Version').item.json.userId }}"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  30000,
                                                         "response":  {
                                                                          "response":  {
                                                                                           "responseFormat":  "json"
            }
          }
        }
      },
                      "id":  "http-check-consents",
                      "name":  "HTTP Request - Check Consents",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       1250,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
            {
                                                                                     "name":  "aiConsent",
                                                                                     "value":  "={{ ($json.AiConsent ?? $json.aiConsent ?? $json.data?.AiConsent ?? $json.data?.aiConsent ?? false) === true }}",
                                                                                     "type":  "boolean"
            },
            {
                                                                                     "name":  "publishingConsent",
                                                                                     "value":  "={{ ($json.PublishingConsent ?? $json.publishingConsent ?? $json.data?.PublishingConsent ?? $json.data?.publishingConsent ?? false) === true }}",
                                                                                     "type":  "boolean"
            },
            {
                                                                                     "name":  "tenantId",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.tenantId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "userId",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.userId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "campaignId",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.campaignId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "instruction",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.instruction }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "channels",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.channels }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "assets",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.assets }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "requiresApproval",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.requiresApproval }}",
                                                                                     "type":  "boolean"
            },
            {
                                                                                     "name":  "validatedData",
                                                                                     "value":  "={{ $('Set Cognitive Engine Version').item.json.validatedData }}",
                                                                                     "type":  "object"
            }
          ]
        },
                                         "options":  {

                                                     }
      },
                      "id":  "normalize-consents",
                      "name":  "Normalize Consents",
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3,
                      "position":  [
                                       1450,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.aiConsent === true && $json.publishingConsent === true }}",
                                                                                   "rightValue":  "",
                                                                                   "operator":  {
                                                                                                    "type":  "boolean",
                                                                                                    "operation":  "true",
                                                                                                    "singleValue":  true
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "validate-consents",
                      "name":  "Validate Consents",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       1650,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "respondWith":  "json",
                                         "responseBody":  "={{ { success:false, error:\u0027Missing consents\u0027, message:\u0027User does not have required consents to proceed\u0027, aiConsent:$json.aiConsent, publishingConsent:$json.publishingConsent } }}",
                                         "options":  {
                                                         "responseCode":  403
        }
      },
                      "id":  "respond-consent-error",
                      "name":  "Respond - Consent Error",
                      "type":  "n8n-nodes-base.respondToWebhook",
                      "typeVersion":  1,
                      "position":  [
                                       1850,
                                       300
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/Memory/context",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId ?? $('Normalize Consents').item.json.tenantId }}"
            },
            {
                                                                                        "name":  "userId",
                                                                                        "value":  "={{ $json.userId ?? $('Normalize Consents').item.json.userId }}"
            },
            {
                                                                                        "name":  "campaignId",
                                                                                        "value":  "={{ $json.campaignId ?? $('Normalize Consents').item.json.campaignId }}"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-load-memory",
                      "name":  "HTTP Request - Load Marketing Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       1850,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
            {
                                                                                     "name":  "memory",
                                                                                     "value":  "={{ { preferredTone: $json.preferences?.preferredTone || \u0027profesional\u0027, dislikedFormats: $json.preferences?.dislikedFormats || [], bestPerformingChannels: $json.learnings?.bestPerformingChannels || [], restrictions: $json.restrictions || [], userPreferences: $json.userPreferences || [], recentConversations: $json.recentConversations || [], campaignMemories: $json.campaignMemories || [], learnings: $json.learnings || {} } }}",
                                                                                     "type":  "object"
            },
            {
                                                                                     "name":  "tenantId",
                                                                                     "value":  "={{ $json.tenantId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "userId",
                                                                                     "value":  "={{ $json.userId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "instruction",
                                                                                     "value":  "={{ $('Normalize Consents').item.json.instruction }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "channels",
                                                                                     "value":  "={{ $('Normalize Consents').item.json.channels }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "assets",
                                                                                     "value":  "={{ $('Normalize Consents').item.json.assets }}",
                                                                                     "type":  "array"
            },
            {
                                                                                     "name":  "campaignId",
                                                                                     "value":  "={{ $json.campaignId }}",
                                                                                     "type":  "string"
            },
            {
                                                                                     "name":  "requiresApproval",
                                                                                     "value":  "={{ $('Normalize Consents').item.json.requiresApproval }}",
                                                                                     "type":  "boolean"
            }
          ]
        },
                                         "options":  {

                                                     }
      },
                      "id":  "normalize-memory",
                      "name":  "Normalize Memory",
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3,
                      "position":  [
                                       2050,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/Memory/context",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId }}"
            },
            {
                                                                                        "name":  "memoryType",
                                                                                        "value":  "Preference"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-load-preference-memory",
                      "name":  "HTTP Request - Load Preference Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       2250,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/Memory/context",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId }}"
            },
            {
                                                                                        "name":  "memoryType",
                                                                                        "value":  "Learning"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-load-performance-memory",
                      "name":  "HTTP Request - Load Performance Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       2250,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/Memory/context",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId }}"
            },
            {
                                                                                        "name":  "memoryType",
                                                                                        "value":  "Feedback"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-load-constraint-memory",
                      "name":  "HTTP Request - Load Constraint Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       2250,
                                       600
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/Memory/context",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId }}"
            },
            {
                                                                                        "name":  "memoryType",
                                                                                        "value":  "Pattern"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-load-pattern-memory",
                      "name":  "HTTP Request - Load Pattern Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       2250,
                                       700
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "GET",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/marketing-packs",
                                         "sendQuery":  true,
                                         "queryParameters":  {
                                                                 "parameters":  [
            {
                                                                                        "name":  "tenantId",
                                                                                        "value":  "={{ $json.tenantId }}"
            },
            {
                                                                                        "name":  "orderBy",
                                                                                        "value":  "cognitiveVersion"
            },
            {
                                                                                        "name":  "limit",
                                                                                        "value":  "1"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-get-last-cognitive-version",
                      "name":  "HTTP Request - Get Last Cognitive Version",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       2250,
                                       800
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Consolidar las 4 memorias avanzadas\nconst preferenceMemory = $(\u0027HTTP Request - Load Preference Memory\u0027).item?.json || {};\nconst performanceMemory = $(\u0027HTTP Request - Load Performance Memory\u0027).item?.json || {};\nconst constraintMemory = $(\u0027HTTP Request - Load Constraint Memory\u0027).item?.json || {};\nconst patternMemoryData = $(\u0027HTTP Request - Load Pattern Memory\u0027).item?.json || {};\nconst baseData = $(\u0027Normalize Memory\u0027).item.json;\n\n// Obtener lastCognitiveVersion de HTTP Request - Get Last Cognitive Version\nconst lastCognitiveVersionResponse = $(\u0027HTTP Request - Get Last Cognitive Version\u0027).item?.json || {};\nconst lastPack = Array.isArray(lastCognitiveVersionResponse) ? \n  (lastCognitiveVersionResponse[0] || {}) : \n  (lastCognitiveVersionResponse.data?.[0] || lastCognitiveVersionResponse);\nconst lastCognitiveVersion = lastPack?.cognitiveVersion ?? \n  (lastPack?.metadata ? (JSON.parse(lastPack.metadata)?.cognitiveVersion ?? null) : null) ?? 1;\n\n// Extraer patrones fallidos y exitosos de PatternMemory\n// Los patrones vienen como memorias individuales, necesitamos parsearlas\nconst patternMemories = Array.isArray(patternMemoryData) ? patternMemoryData : (patternMemoryData.data ? patternMemoryData.data : []);\nconst failedPatterns = [];\nconst successfulPatterns = [];\n\n// BLOQUEO TEMPORAL: Identificar patrones fallidos repetidamente\n// FASE 3: Soporte para severity/blockStatus determinístico\nconst patternFailureCount = {};\nconst blockedPatterns = [];\nconst patternTimestamps = {};\n\n// Función determinística para calcular días desde timestamp\nfunction daysSinceTimestamp(timestamp, referenceTimestamp) {\n  if (!timestamp || !referenceTimestamp) return 999; // Si no hay timestamp, asumir muy antiguo\n  try {\n    const ts = new Date(timestamp).getTime();\n    const ref = new Date(referenceTimestamp).getTime();\n    if (isNaN(ts) || isNaN(ref)) return 999;\n    return Math.round(((ref - ts) / (1000 * 60 * 60 * 24)) * 10000) / 10000; // Redondear a 4 decimales\n  } catch (e) {\n    return 999;\n  }\n}\n\n// Obtener timestamp de referencia determinístico (del validatedData si existe)\nconst validatedData = $(\u0027Set Validated Data\u0027).item?.json?.validatedData || {};\nconst referenceTimestamp = validatedData.receivedAt || new Date().toISOString();\n\npatternMemories.forEach(memory =\u003e {\n  try {\n    const content = typeof memory.content === \u0027string\u0027 ? JSON.parse(memory.content) : memory.content;\n    const pattern = content.pattern || JSON.stringify(content);\n    \n    if (content.result === \u0027negative\u0027 || (content.penalty \u0026\u0026 content.penalty \u003c 0) || content.result === \u0027override_result\u0027) {\n      // Contar fallos por patrón\n      patternFailureCount[pattern] = (patternFailureCount[pattern] || 0) + 1;\n      const memoryTimestamp = content.timestamp || content.context?.evaluationTime || referenceTimestamp;\n      patternTimestamps[pattern] = memoryTimestamp;\n      \n      // Extraer severity si existe (de Fase 3)\n      const severity = content.severity || \u0027moderate\u0027; // Default si no existe\n      const penalty = Math.round((content.penalty || -0.2) * 10000) / 10000; // Redondear a 4 decimales\n      \n      // Calcular días desde fallo (determinístico)\n      const daysSinceFailure = daysSinceTimestamp(memoryTimestamp, referenceTimestamp);\n      \n      // Si un patrón falla 3+ veces, bloquearlo temporalmente (30 días)\n      if (patternFailureCount[pattern] \u003e= 3 \u0026\u0026 daysSinceFailure \u003c 30) {\n        blockedPatterns.push(pattern);\n      }\n      \n      failedPatterns.push({ \n        pattern: pattern, \n        failureCount: patternFailureCount[pattern], \n        penalty: penalty,\n        severity: severity,\n        timestamp: memoryTimestamp,\n        daysSinceFailure: daysSinceFailure\n      });\n    } else if (content.result === \u0027positive\u0027 || (content.penalty \u0026\u0026 content.penalty \u003e 0)) {\n      const penalty = Math.round((content.penalty || 0.1) * 10000) / 10000; // Redondear a 4 decimales\n      successfulPatterns.push({ pattern: pattern, penalty: penalty });\n    }\n  } catch (e) {\n    // Ignorar errores de parsing\n  }\n});\n\n// Extraer datos estructurados de cada tipo de memoria\nconst advancedMemory = {\n  preferenceMemory: {\n    preferredTone: preferenceMemory.preferences?.preferredTone || baseData.memory?.preferredTone || \u0027profesional\u0027,\n    preferredFormats: preferenceMemory.preferences?.preferredFormats || [],\n    preferredChannels: preferenceMemory.preferences?.preferredChannels || [],\n    dislikedFormats: preferenceMemory.preferences?.dislikedFormats || baseData.memory?.dislikedFormats || [],\n    stylePreferences: preferenceMemory.preferences?.stylePreferences || {}\n  },\n  performanceMemory: {\n    bestPerformingChannels: performanceMemory.learnings?.bestPerformingChannels || baseData.memory?.bestPerformingChannels || [],\n    channelKPIs: performanceMemory.learnings?.channelKPIs || {},\n    bestTimes: performanceMemory.learnings?.bestTimes || [],\n    bestDays: performanceMemory.learnings?.bestDays || [],\n    avgCTR: performanceMemory.learnings?.avgCTR || 0,\n    avgEngagement: performanceMemory.learnings?.avgEngagement || 0,\n    topPerformers: performanceMemory.learnings?.topPerformers || []\n  },\n  constraintMemory: {\n    restrictions: constraintMemory.restrictions || baseData.memory?.restrictions || [],\n    prohibitedChannels: constraintMemory.restrictions?.filter(r =\u003e r.includes(\u0027channel\u0027) || r.includes(\u0027prohibited\u0027)) || [],\n    legalConstraints: constraintMemory.restrictions?.filter(r =\u003e r.includes(\u0027legal\u0027) || r.includes(\u0027compliance\u0027)) || [],\n    brandConstraints: constraintMemory.restrictions?.filter(r =\u003e r.includes(\u0027brand\u0027) || r.includes(\u0027guidelines\u0027)) || []\n  },\n  patternMemory: {\n    successfulPatterns: successfulPatterns,\n    failedPatterns: failedPatterns,\n    blockedPatterns: blockedPatterns,\n    patternFailureCount: patternFailureCount,\n    patternTimestamps: patternTimestamps,\n    urgencyFormatMapping: patternMemoryData.urgencyFormatMapping || {},\n    channelFormatMapping: patternMemoryData.channelFormatMapping || {},\n    toneChannelMapping: patternMemoryData.toneChannelMapping || {}\n  }\n};\n\n// Calcular confidence weights basados en historial\nconst confidenceWeights = {\n  channel: calculateChannelConfidence(advancedMemory.performanceMemory.bestPerformingChannels, advancedMemory.performanceMemory.channelKPIs),\n  format: calculateFormatConfidence(advancedMemory.patternMemory.urgencyFormatMapping, advancedMemory.performanceMemory.topPerformers),\n  tone: calculateToneConfidence(advancedMemory.performanceMemory.topPerformers, advancedMemory.patternMemory.toneChannelMapping),\n  timing: calculateTimingConfidence(advancedMemory.performanceMemory.bestTimes, advancedMemory.performanceMemory.bestDays)\n};\n\nfunction calculateChannelConfidence(bestChannels, channelKPIs) {\n  const weights = {};\n  if (bestChannels \u0026\u0026 bestChannels.length \u003e 0) {\n    bestChannels.forEach((channel, index) =\u003e {\n      const kpi = channelKPIs[channel] || {};\n      const ctr = kpi.ctr || 0;\n      const engagement = kpi.engagement || 0;\n      \n      // AUTO-AJUSTE: Penaliza canales con bajo rendimiento y refuerza exitosos\n      let baseWeight = 0.5 + (ctr * 10) + (engagement * 5); // CTR y engagement influyen directamente\n      \n      // Penalización fuerte si CTR \u003c 0.5% o engagement \u003c 1%\n      if (ctr \u003c 0.005) baseWeight -= 0.3;\n      if (engagement \u003c 0.01) baseWeight -= 0.2;\n      \n      // Refuerzo si CTR \u003e 2% o engagement \u003e 5%\n      if (ctr \u003e 0.02) baseWeight += 0.2;\n      if (engagement \u003e 0.05) baseWeight += 0.15;\n      \n      // Ajuste por posición (los primeros tienen más peso)\n      baseWeight -= (index * 0.05);\n      \n      weights[channel] = Math.max(0.1, Math.min(0.9, baseWeight));\n    });\n  }\n  return weights;\n}\n\nfunction calculateFormatConfidence(urgencyFormatMapping, topPerformers) {\n  const weights = {};\n  \n  // AUTO-AJUSTE: Refuerza formatos exitosos y penaliza fallidos\n  if (urgencyFormatMapping \u0026\u0026 Object.keys(urgencyFormatMapping).length \u003e 0) {\n    Object.entries(urgencyFormatMapping).forEach(([urgency, format]) =\u003e {\n      // Si está en el mapeo, es porque ha sido exitoso\n      weights[`${urgency}_${format}`] = 0.75; // Aumentado de 0.7 a 0.75\n    });\n  }\n  \n  if (topPerformers \u0026\u0026 topPerformers.length \u003e 0) {\n    topPerformers.forEach((performer, index) =\u003e {\n      if (performer.format) {\n        // Los top performers refuerzan más\n        const boost = 0.15 - (index * 0.02); // Más boost para los primeros\n        weights[performer.format] = (weights[performer.format] || 0.5) + boost;\n      }\n    });\n  }\n  \n  // Normalizar todos los pesos\n  Object.keys(weights).forEach(key =\u003e {\n    weights[key] = Math.max(0.1, Math.min(0.9, weights[key]));\n  });\n  \n  return weights;\n}\n\nfunction calculateToneConfidence(topPerformers, toneChannelMapping) {\n  const weights = {};\n  \n  // AUTO-AJUSTE: Refuerza tonos con alto engagement y penaliza los de bajo rendimiento\n  if (topPerformers \u0026\u0026 topPerformers.length \u003e 0) {\n    topPerformers.forEach((performer, index) =\u003e {\n      if (performer.tone) {\n        // Más refuerzo para los primeros (mejores performers)\n        const boost = 0.12 - (index * 0.015);\n        weights[performer.tone] = (weights[performer.tone] || 0.5) + boost;\n      }\n    });\n  }\n  \n  if (toneChannelMapping \u0026\u0026 Object.keys(toneChannelMapping).length \u003e 0) {\n    Object.entries(toneChannelMapping).forEach(([tone, channels]) =\u003e {\n      if (Array.isArray(channels) \u0026\u0026 channels.length \u003e 0) {\n        // Más canales = más refuerzo\n        const boost = 0.15 + (channels.length * 0.02);\n        weights[tone] = (weights[tone] || 0.5) + boost;\n      }\n    });\n  }\n  \n  // Normalizar todos los pesos\n  Object.keys(weights).forEach(key =\u003e {\n    weights[key] = Math.max(0.1, Math.min(0.9, weights[key]));\n  });\n  \n  return weights;\n}\n\nfunction calculateTimingConfidence(bestTimes, bestDays) {\n  const weights = { times: {}, days: {} };\n  if (bestTimes \u0026\u0026 bestTimes.length \u003e 0) {\n    bestTimes.forEach(time =\u003e {\n      weights.times[time] = 0.7;\n    });\n  }\n  if (bestDays \u0026\u0026 bestDays.length \u003e 0) {\n    bestDays.forEach(day =\u003e {\n      weights.days[day] = 0.7;\n    });\n  }\n  return weights;\n}\n\n// AUTO-AJUSTE: Aplicar penalizaciones automáticas a patrones fallidos\n// BLOQUEO TEMPORAL: Excluir patrones bloqueados\nconst avoidPatterns = failedPatterns\n  .filter(pattern =\u003e {\n    const patternStr = typeof pattern === \u0027object\u0027 ? pattern.pattern : pattern;\n    return !blockedPatterns.includes(patternStr);\n  })\n  .map(pattern =\u003e {\n    // Si el patrón tiene penalización negativa, se evita más\n    if (typeof pattern === \u0027object\u0027 \u0026\u0026 pattern.penalty \u0026\u0026 pattern.penalty \u003c 0) {\n      return pattern.pattern || JSON.stringify(pattern);\n    }\n    return typeof pattern === \u0027string\u0027 ? pattern : (pattern.pattern || JSON.stringify(pattern));\n  });\r\n\r\nreturn {\n  ...baseData,\n  advancedMemory: advancedMemory,\n  confidenceWeights: confidenceWeights,\n  learnedBestChannels: advancedMemory.performanceMemory.bestPerformingChannels || [],\n  avoidPatterns: avoidPatterns,\n  preferredFormats: advancedMemory.preferenceMemory.preferredFormats || [],\n  successfulPatterns: successfulPatterns,\n  lastCognitiveVersion: lastCognitiveVersion\n};"
      },
                      "id":  "consolidate-advanced-memory",
                      "name":  "Consolidate Advanced Memory",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       2450,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "resource":  "chat",
                                         "operation":  "create",
                                         "model":  "={{ $env.OPENAI_MODEL || \u0027gpt-4\u0027 }}",
                                         "messages":  {
                                                          "values":  [
            {
                                                                             "role":  "system",
                                                                             "content":  "Eres un analizador experto de instrucciones de marketing con acceso a memoria cognitiva avanzada. Tu tarea es analizar la instrucción del usuario y extraer información estructurada, PRIORIZANDO automáticamente canales, formatos y tonos con mejor performance histórica. DEBES responder SOLO con un JSON válido, sin texto adicional, sin markdown, sin explicaciones. El JSON debe tener exactamente esta estructura:\n\n{\n  \"objective\": \"string - objetivo principal de la instrucción\",\n  \"tone\": \"string - tono recomendado (profesional, casual, formal, amigable, técnico, etc.) - PRIORIZA tonos con mayor engagement histórico\",\n  \"urgency\": \"string - nivel de urgencia (low, medium, high, critical)\",\n  \"contentType\": \"string - tipo de contenido recomendado (post, story, reel, video, carousel, article, etc.) - PRIORIZA formatos exitosos para esta urgencia\",\n  \"targetAudience\": \"string - audiencia objetivo si se menciona\",\n  \"keyMessages\": [\"string\"],\n  \"hashtags\": [\"string\"],\n  \"channels\": [\"string\"] - PRIORIZA canales con mejor performance histórica\n}"
            },
            {
                                                                             "role":  "user",
                                                                             "content":  "={{ \u0027Analiza la siguiente instrucción de marketing y extrae la información estructurada, PRIORIZANDO automáticamente basándote en el aprendizaje histórico:\\n\\n## Instrucción:\\n\u0027 + $json.instruction + \u0027\\n\\n## Memoria Cognitiva Avanzada:\\n\u0027 + JSON.stringify({ learnedBestChannels: $json.learnedBestChannels || [], avoidPatterns: $json.avoidPatterns || [], preferredFormats: $json.preferredFormats || [], confidenceWeights: $json.confidenceWeights || {} }, null, 2) + \u0027\\n\\nResponde SOLO con el JSON, sin texto adicional.\u0027 }}"
            }
          ]
        },
                                         "options":  {
                                                         "temperature":  0.3,
                                                         "maxTokens":  500
        },
                                         "authentication":  "openAiApi"
      },
                      "id":  "openai-analyze",
                      "name":  "OpenAI - Analyze Instruction (Cognitive)",
                      "type":  "n8n-nodes-base.openAi",
                      "typeVersion":  1,
                      "position":  [
                                       2250,
                                       500
                                   ],
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "openai-api-credentials",
                                                            "name":  "OpenAI API"
        }
      }
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Parsear la respuesta de OpenAI\nconst response = $input.item.json;\nlet analysis = {};\n\ntry {\n  let content = response.choices?.[0]?.message?.content || response.message?.content || \u0027\u0027;\n  content = content.trim();\n  if (content.startsWith(\u0027```json\u0027)) {\n    content = content.replace(/```json\\s*/g, \u0027\u0027).replace(/```\\s*/g, \u0027\u0027);\n  } else if (content.startsWith(\u0027```\u0027)) {\n    content = content.replace(/```\\s*/g, \u0027\u0027);\n  }\n  analysis = JSON.parse(content);\n} catch (error) {\n  try {\n    const jsonMatch = response.choices?.[0]?.message?.content?.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      analysis = JSON.parse(jsonMatch[0]);\n    } else {\n      analysis = {\n        objective: \u0027No se pudo determinar\u0027,\n        tone: \u0027profesional\u0027,\n        urgency: \u0027medium\u0027,\n        contentType: \u0027post\u0027,\n        targetAudience: \u0027\u0027,\n        keyMessages: [],\n        hashtags: [],\n        channels: []\n      };\n    }\n  } catch (parseError) {\n    analysis = {\n      objective: \u0027Error al analizar\u0027,\n      tone: \u0027profesional\u0027,\n      urgency: \u0027medium\u0027,\n      contentType: \u0027post\u0027,\n      targetAudience: \u0027\u0027,\n      keyMessages: [],\n      hashtags: [],\n      channels: []\n    };\n  }\n}\n\nconst memory = $(\u0027Normalize Memory\u0027).item.json.memory || {};\nconst result = {\n  objective: analysis.objective || \u0027No especificado\u0027,\n  tone: analysis.tone || memory.preferredTone || \u0027profesional\u0027,\n  urgency: analysis.urgency || \u0027medium\u0027,\n  contentType: analysis.contentType || \u0027post\u0027,\n  targetAudience: analysis.targetAudience || \u0027\u0027,\n  keyMessages: Array.isArray(analysis.keyMessages) ? analysis.keyMessages : [],\n  hashtags: Array.isArray(analysis.hashtags) ? analysis.hashtags : [],\n  channels: Array.isArray(analysis.channels) ? analysis.channels : ($(\u0027Normalize Memory\u0027).item.json.channels || []),\n  originalInstruction: $(\u0027Normalize Memory\u0027).item.json.instruction,\n  analyzedAt: new Date().toISOString(),\n  tenantId: $(\u0027Normalize Memory\u0027).item.json.tenantId || \u0027\u0027,\n  userId: $(\u0027Normalize Memory\u0027).item.json.userId || \u0027\u0027\n};\n\nreturn {\n  ...$(\u0027Normalize Memory\u0027).item.json,\n  analysis: result\n};"
      },
                      "id":  "parse-analysis",
                      "name":  "Parse Analysis",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       2450,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "resource":  "chat",
                                         "operation":  "create",
                                         "model":  "={{ $env.OPENAI_MODEL || \u0027gpt-4\u0027 }}",
                                         "messages":  {
                                                          "values":  [
            {
                                                                             "role":  "system",
                                                                             "content":  "Eres un estratega de marketing experto. Tu tarea es generar una estrategia de marketing completa basada en el análisis de la instrucción del usuario y la memoria histórica del tenant. DEBES responder SOLO con un JSON válido, sin texto adicional, sin markdown, sin explicaciones. El JSON debe tener exactamente esta estructura:\n\n{\n  \"mainMessage\": \"string - mensaje principal de la campaña\",\n  \"cta\": \"string - call to action claro y directo\",\n  \"recommendedFormat\": \"string - formato recomendado (post, story, reel, video, carousel, article)\",\n  \"suggestedSchedule\": {\n    \"bestDays\": [\"string\"],\n    \"bestTimes\": [\"string\"],\n    \"timezone\": \"string\"\n  },\n  \"contentStructure\": {\n    \"headline\": \"string\",\n    \"body\": \"string\",\n    \"hashtags\": [\"string\"],\n    \"mentions\": [\"string\"]\n  },\n  \"channels\": [\"string\"],\n  \"tone\": \"string\",\n  \"targetAudience\": \"string\",\n  \"keyPoints\": [\"string\"]\n}"
            },
            {
                                                                             "role":  "user",
                                                                             "content":  "={{ \u0027Genera una estrategia de marketing completa basada en la siguiente información, PRIORIZANDO automáticamente decisiones con mayor probabilidad de éxito según el aprendizaje histórico:\\n\\n## Análisis de la Instrucción:\\n\u0027 + JSON.stringify($json.analysis, null, 2) + \u0027\\n\\n## Memoria Cognitiva Avanzada:\\n\u0027 + JSON.stringify({ learnedBestChannels: $json.learnedBestChannels || [], avoidPatterns: $json.avoidPatterns || [], preferredFormats: $json.preferredFormats || [], confidenceWeights: $json.confidenceWeights || {}, performanceMemory: $json.advancedMemory?.performanceMemory || {}, patternMemory: $json.advancedMemory?.patternMemory || {} }, null, 2) + \u0027\\n\\n## Memoria Histórica del Tenant:\\n\u0027 + JSON.stringify($json.memory, null, 2) + \u0027\\n\\nConsidera y PRIORIZA:\\n- Canales con mejor performance histórica (confidenceWeights.channel)\\n- Formatos exitosos para esta urgencia (patternMemory.urgencyFormatMapping)\\n- Tonos con mayor engagement (confidenceWeights.tone)\\n- Horarios óptimos (confidenceWeights.timing)\\n- EVITA patrones fallidos (avoidPatterns)\\n- El objetivo identificado en el análisis\\n- Las restricciones y aprendizajes\\n\\nResponde SOLO con el JSON de la estrategia, sin texto adicional.\u0027 }}"
            }
          ]
        },
                                         "options":  {
                                                         "temperature":  0.7,
                                                         "maxTokens":  1000
        },
                                         "authentication":  "openAiApi"
      },
                      "id":  "openai-strategy",
                      "name":  "OpenAI - Generate Strategy",
                      "type":  "n8n-nodes-base.openAi",
                      "typeVersion":  1,
                      "position":  [
                                       2650,
                                       500
                                   ],
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "openai-api-credentials",
                                                            "name":  "OpenAI API"
        }
      }
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Parsear la respuesta de OpenAI\nconst response = $input.item.json;\nlet strategy = {};\n\ntry {\n  let content = response.choices?.[0]?.message?.content || response.message?.content || \u0027\u0027;\n  content = content.trim();\n  if (content.startsWith(\u0027```json\u0027)) {\n    content = content.replace(/```json\\s*/g, \u0027\u0027).replace(/```\\s*/g, \u0027\u0027);\n  } else if (content.startsWith(\u0027```\u0027)) {\n    content = content.replace(/```\\s*/g, \u0027\u0027);\n  }\n  strategy = JSON.parse(content);\n} catch (error) {\n  try {\n    const jsonMatch = response.choices?.[0]?.message?.content?.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      strategy = JSON.parse(jsonMatch[0]);\n    } else {\n      const analysis = $(\u0027Parse Analysis\u0027).item.json.analysis || {};\n      strategy = {\n        mainMessage: analysis.objective || \u0027Mensaje principal de la campaña\u0027,\n        cta: \u0027Descubre más\u0027,\n        recommendedFormat: analysis.contentType || \u0027post\u0027,\n        suggestedSchedule: { bestDays: [\u0027lunes\u0027, \u0027miércoles\u0027, \u0027viernes\u0027], bestTimes: [\u002709:00\u0027, \u002713:00\u0027, \u002718:00\u0027], timezone: \u0027UTC\u0027 },\n        contentStructure: { headline: analysis.objective || \u0027\u0027, body: \u0027\u0027, hashtags: analysis.hashtags || [], mentions: [] },\n        channels: analysis.channels || [],\n        tone: analysis.tone || \u0027profesional\u0027,\n        targetAudience: analysis.targetAudience || \u0027\u0027,\n        keyPoints: analysis.keyMessages || []\n      };\n    }\n  } catch (parseError) {\n    const analysis = $(\u0027Parse Analysis\u0027).item.json.analysis || {};\n    strategy = {\n      mainMessage: \u0027Estrategia de marketing\u0027,\n      cta: \u0027Descubre más\u0027,\n      recommendedFormat: \u0027post\u0027,\n      suggestedSchedule: { bestDays: [\u0027lunes\u0027, \u0027miércoles\u0027, \u0027viernes\u0027], bestTimes: [\u002709:00\u0027, \u002713:00\u0027, \u002718:00\u0027], timezone: \u0027UTC\u0027 },\n      contentStructure: { headline: \u0027\u0027, body: \u0027\u0027, hashtags: [], mentions: [] },\n      channels: [],\n      tone: \u0027profesional\u0027,\n      targetAudience: \u0027\u0027,\n      keyPoints: []\n    };\n  }\n}\n\nconst finalStrategy = {\n  mainMessage: strategy.mainMessage || \u0027Mensaje principal de la campaña\u0027,\n  cta: strategy.cta || \u0027Descubre más\u0027,\n  recommendedFormat: strategy.recommendedFormat || \u0027post\u0027,\n  suggestedSchedule: {\n    bestDays: Array.isArray(strategy.suggestedSchedule?.bestDays) ? strategy.suggestedSchedule.bestDays : [\u0027lunes\u0027, \u0027miércoles\u0027, \u0027viernes\u0027],\n    bestTimes: Array.isArray(strategy.suggestedSchedule?.bestTimes) ? strategy.suggestedSchedule.bestTimes : [\u002709:00\u0027, \u002713:00\u0027, \u002718:00\u0027],\n    timezone: strategy.suggestedSchedule?.timezone || \u0027UTC\u0027\n  },\n  contentStructure: {\n    headline: strategy.contentStructure?.headline || \u0027\u0027,\n    body: strategy.contentStructure?.body || \u0027\u0027,\n    hashtags: Array.isArray(strategy.contentStructure?.hashtags) ? strategy.contentStructure.hashtags : [],\n    mentions: Array.isArray(strategy.contentStructure?.mentions) ? strategy.contentStructure.mentions : []\n  },\n  channels: Array.isArray(strategy.channels) ? strategy.channels : ($(\u0027Parse Analysis\u0027).item.json.channels || []),\n  tone: strategy.tone || \u0027profesional\u0027,\n  targetAudience: strategy.targetAudience || \u0027\u0027,\n  keyPoints: Array.isArray(strategy.keyPoints) ? strategy.keyPoints : []\n};\n\nconst metadata = {\n  tenantId: $(\u0027Parse Analysis\u0027).item.json.tenantId || \u0027\u0027,\n  generatedAt: new Date().toISOString(),\n  basedOnAnalysis: $(\u0027Parse Analysis\u0027).item.json.analysis || {},\n  basedOnMemory: $(\u0027Parse Analysis\u0027).item.json.memory || {}\n};\n\nreturn {\n  ...$(\u0027Parse Analysis\u0027).item.json,\n  strategy: { ...finalStrategy, metadata }\n};"
      },
                      "id":  "parse-strategy",
                      "name":  "Parse Strategy",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       2850,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "resource":  "chat",
                                         "operation":  "create",
                                         "model":  "={{ $env.OPENAI_MODEL || \u0027gpt-4\u0027 }}",
                                         "messages":  {
                                                          "values":  [
            {
                                                                             "role":  "system",
                                                                             "content":  "Eres un copywriter experto de marketing digital. Tu tarea es generar copy de marketing listo para publicar en redes sociales. DEBES responder SOLO con un JSON válido, sin texto adicional, sin markdown, sin explicaciones. El JSON debe tener exactamente esta estructura:\n\n{\n  \"shortCopy\": \"string - copy corto (máximo 125 caracteres, ideal para stories o tweets)\",\n  \"longCopy\": \"string - copy largo (máximo 500 caracteres, ideal para posts)\",\n  \"hashtags\": [\"string\"],\n  \"variants\": {\n    \"variantA\": {\n      \"shortCopy\": \"string\",\n      \"longCopy\": \"string\",\n      \"hashtags\": [\"string\"]\n    },\n    \"variantB\": {\n      \"shortCopy\": \"string\",\n      \"longCopy\": \"string\",\n      \"hashtags\": [\"string\"]\n    }\n  },\n  \"headline\": \"string - título llamativo\",\n  \"cta\": \"string - call to action optimizado\",\n  \"emojiSuggestions\": [\"string\"],\n  \"mentions\": [\"string\"]\n}"
            },
            {
                                                                             "role":  "user",
                                                                             "content":  "={{ \u0027Genera copy de marketing listo para publicar basado en la siguiente estrategia, OPTIMIZANDO para canales con mejor performance histórico:\\n\\n## Estrategia:\\n\u0027 + JSON.stringify($json.strategy, null, 2) + \u0027\\n\\n## Memoria Cognitiva Avanzada:\\n\u0027 + JSON.stringify({ learnedBestChannels: $json.learnedBestChannels || [], avoidPatterns: $json.avoidPatterns || [], confidenceWeights: $json.confidenceWeights || {}, performanceMemory: $json.advancedMemory?.performanceMemory || {} }, null, 2) + \u0027\\n\\nConsidera y OPTIMIZA:\\n- El mensaje principal: \u0027 + ($json.strategy.mainMessage || \u0027\u0027) + \u0027\\n- El CTA: \u0027 + ($json.strategy.cta || \u0027\u0027) + \u0027\\n- El tono: \u0027 + ($json.strategy.tone || \u0027profesional\u0027) + \u0027 (prioriza tonos con mayor engagement histórico)\\n- El formato recomendado: \u0027 + ($json.strategy.recommendedFormat || \u0027post\u0027) + \u0027\\n- La audiencia objetivo: \u0027 + ($json.strategy.targetAudience || \u0027\u0027) + \u0027\\n- Los puntos clave: \u0027 + JSON.stringify($json.strategy.keyPoints || []) + \u0027\\n- Los canales: \u0027 + JSON.stringify($json.strategy.channels || []) + \u0027 (prioriza canales con mejor CTR y engagement)\\n- EVITA patrones que han fallado históricamente\\n\\nResponde SOLO con el JSON del copy, sin texto adicional.\u0027 }}"
            }
          ]
        },
                                         "options":  {
                                                         "temperature":  0.8,
                                                         "maxTokens":  1500
        },
                                         "authentication":  "openAiApi"
      },
                      "id":  "openai-copy",
                      "name":  "OpenAI - Generate Copy",
                      "type":  "n8n-nodes-base.openAi",
                      "typeVersion":  1,
                      "position":  [
                                       3050,
                                       500
                                   ],
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "openai-api-credentials",
                                                            "name":  "OpenAI API"
        }
      }
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Parsear la respuesta de OpenAI\nconst response = $input.item.json;\nlet copyData = {};\n\ntry {\n  let content = response.choices?.[0]?.message?.content || response.message?.content || \u0027\u0027;\n  content = content.trim();\n  if (content.startsWith(\u0027```json\u0027)) {\n    content = content.replace(/```json\\s*/g, \u0027\u0027).replace(/```\\s*/g, \u0027\u0027);\n  } else if (content.startsWith(\u0027```\u0027)) {\n    content = content.replace(/```\\s*/g, \u0027\u0027);\n  }\n  copyData = JSON.parse(content);\n} catch (error) {\n  try {\n    const jsonMatch = response.choices?.[0]?.message?.content?.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      copyData = JSON.parse(jsonMatch[0]);\n    } else {\n      const strategy = $(\u0027Parse Strategy\u0027).item.json.strategy || {};\n      copyData = {\n        shortCopy: strategy.mainMessage || \u0027Descubre más\u0027,\n        longCopy: (strategy.contentStructure?.body || strategy.mainMessage || \u0027\u0027) + \u0027\\n\\n\u0027 + (strategy.cta || \u0027\u0027),\n        hashtags: strategy.contentStructure?.hashtags || strategy.keyPoints || [],\n        variants: {\n          variantA: { shortCopy: strategy.mainMessage || \u0027Descubre más\u0027, longCopy: (strategy.contentStructure?.body || strategy.mainMessage || \u0027\u0027) + \u0027\\n\\n\u0027 + (strategy.cta || \u0027\u0027), hashtags: strategy.contentStructure?.hashtags || [] },\n          variantB: { shortCopy: strategy.mainMessage || \u0027Explora ahora\u0027, longCopy: (strategy.contentStructure?.body || strategy.mainMessage || \u0027\u0027) + \u0027\\n\\n\u0027 + (strategy.cta || \u0027\u0027), hashtags: strategy.contentStructure?.hashtags || [] }\n        },\n        headline: strategy.contentStructure?.headline || strategy.mainMessage || \u0027\u0027,\n        cta: strategy.cta || \u0027Descubre más\u0027,\n        emojiSuggestions: [],\n        mentions: strategy.contentStructure?.mentions || []\n      };\n    }\n  } catch (parseError) {\n    const strategy = $(\u0027Parse Strategy\u0027).item.json.strategy || {};\n    copyData = {\n      shortCopy: \u0027Copy corto\u0027,\n      longCopy: \u0027Copy largo\u0027,\n      hashtags: [],\n      variants: { variantA: { shortCopy: \u0027\u0027, longCopy: \u0027\u0027, hashtags: [] }, variantB: { shortCopy: \u0027\u0027, longCopy: \u0027\u0027, hashtags: [] } },\n      headline: \u0027\u0027,\n      cta: \u0027\u0027,\n      emojiSuggestions: [],\n      mentions: []\n    };\n  }\n}\n\nconst finalCopy = {\n  shortCopy: copyData.shortCopy || \u0027Copy corto\u0027,\n  longCopy: copyData.longCopy || \u0027Copy largo\u0027,\n  hashtags: Array.isArray(copyData.hashtags) ? copyData.hashtags : [],\n  variants: {\n    variantA: {\n      shortCopy: copyData.variants?.variantA?.shortCopy || copyData.shortCopy || \u0027Variante A - Copy corto\u0027,\n      longCopy: copyData.variants?.variantA?.longCopy || copyData.longCopy || \u0027Variante A - Copy largo\u0027,\n      hashtags: Array.isArray(copyData.variants?.variantA?.hashtags) ? copyData.variants.variantA.hashtags : (copyData.hashtags || [])\n    },\n    variantB: {\n      shortCopy: copyData.variants?.variantB?.shortCopy || copyData.shortCopy || \u0027Variante B - Copy corto\u0027,\n      longCopy: copyData.variants?.variantB?.longCopy || copyData.longCopy || \u0027Variante B - Copy largo\u0027,\n      hashtags: Array.isArray(copyData.variants?.variantB?.hashtags) ? copyData.variants.variantB.hashtags : (copyData.hashtags || [])\n    }\n  },\n  headline: copyData.headline || \u0027\u0027,\n  cta: copyData.cta || \u0027Descubre más\u0027,\n  emojiSuggestions: Array.isArray(copyData.emojiSuggestions) ? copyData.emojiSuggestions : [],\n  mentions: Array.isArray(copyData.mentions) ? copyData.mentions : []\n};\n\nconst strategy = $(\u0027Parse Strategy\u0027).item.json.strategy || {};\nconst publishReady = {\n  ...finalCopy,\n  publishFormat: {\n    instagram: {\n      caption: finalCopy.longCopy + \u0027\\n\\n\u0027 + finalCopy.hashtags.map(h =\u003e \u0027#\u0027 + h.replace(/^#/, \u0027\u0027)).join(\u0027 \u0027),\n      storyText: finalCopy.shortCopy,\n      hashtags: finalCopy.hashtags\n    },\n    facebook: {\n      post: finalCopy.longCopy,\n      hashtags: finalCopy.hashtags\n    },\n    twitter: {\n      tweet: finalCopy.shortCopy,\n      thread: finalCopy.longCopy,\n      hashtags: finalCopy.hashtags\n    }\n  },\n  metadata: {\n    tenantId: $(\u0027Parse Strategy\u0027).item.json.tenantId || \u0027\u0027,\n    generatedAt: new Date().toISOString(),\n    format: strategy.recommendedFormat || \u0027post\u0027,\n    channels: strategy.channels || [],\n    tone: strategy.tone || \u0027profesional\u0027\n  }\n};\n\nreturn {\n  ...$(\u0027Parse Strategy\u0027).item.json,\n  copy: publishReady\n};"
      },
                      "id":  "parse-copy",
                      "name":  "Parse Copy",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       3250,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "resource":  "chat",
                                         "operation":  "create",
                                         "model":  "={{ $env.OPENAI_MODEL || \u0027gpt-4\u0027 }}",
                                         "messages":  {
                                                          "values":  [
            {
                                                                             "role":  "system",
                                                                             "content":  "Eres un experto en generación de prompts para IA visual (DALL-E, Midjourney, Stable Diffusion). Tu tarea es crear prompts optimizados y detallados para generar imágenes y videos basados en el contexto de marketing. DEBES responder SOLO con un JSON válido, sin texto adicional, sin markdown, sin explicaciones. El JSON debe tener exactamente esta estructura:\n\n{\n  \"imagePrompt\": \"string - prompt detallado y optimizado para generación de imágenes (mínimo 50 palabras, incluir estilo, composición, iluminación, colores, mood, detalles técnicos)\",\n  \"videoPrompt\": \"string - prompt detallado y optimizado para generación de videos (mínimo 50 palabras, incluir movimiento, escena, transiciones, estilo visual)\",\n  \"imageStyle\": \"string - estilo visual recomendado (realistic, artistic, minimalist, vibrant, etc.)\",\n  \"colorPalette\": [\"string\"],\n  \"mood\": \"string\",\n  \"aspectRatio\": \"string - formato recomendado (16:9, 1:1, 9:16, etc.)\",\n  \"technicalSpecs\": {\n    \"resolution\": \"string\",\n    \"quality\": \"string\",\n    \"lighting\": \"string\",\n    \"composition\": \"string\"\n  }\n}"
            },
            {
                                                                             "role":  "user",
                                                                             "content":  "={{ \u0027Genera prompts visuales optimizados para IA basados en el siguiente contexto, PRIORIZANDO estilos visuales con mejor performance:\\n\\n## Estrategia de Marketing:\\n\u0027 + JSON.stringify($json.strategy, null, 2) + \u0027\\n\\n## Copy Generado:\\n\u0027 + JSON.stringify($json.copy, null, 2) + \u0027\\n\\n## Memoria Cognitiva Avanzada:\\n\u0027 + JSON.stringify({ learnedBestChannels: $json.learnedBestChannels || [], avoidPatterns: $json.avoidPatterns || [], confidenceWeights: $json.confidenceWeights || {}, performanceMemory: $json.advancedMemory?.performanceMemory || {} }, null, 2) + \u0027\\n\\n## Memoria Histórica:\\n\u0027 + JSON.stringify($json.memory, null, 2) + \u0027\\n\\nConsidera y OPTIMIZA:\\n- El mensaje principal: \u0027 + ($json.strategy.mainMessage || \u0027\u0027) + \u0027\\n- El tono: \u0027 + ($json.strategy.tone || \u0027profesional\u0027) + \u0027 (prioriza estilos visuales que funcionan mejor con este tono)\\n- La audiencia objetivo: \u0027 + ($json.strategy.targetAudience || \u0027\u0027) + \u0027\\n- El formato recomendado: \u0027 + ($json.strategy.recommendedFormat || \u0027post\u0027) + \u0027\\n- Los canales: \u0027 + JSON.stringify($json.strategy.channels || []) + \u0027 (ajusta aspect ratio y estilo según mejor performance por canal)\\n- El copy generado para entender el contexto visual\\n- Las preferencias históricas del tenant\\n- EVITA estilos visuales que han fallado históricamente\\n\\nResponde SOLO con el JSON de los prompts visuales, sin texto adicional.\u0027 }}"
            }
          ]
        },
                                         "options":  {
                                                         "temperature":  0.7,
                                                         "maxTokens":  1200
        },
                                         "authentication":  "openAiApi"
      },
                      "id":  "openai-visual",
                      "name":  "OpenAI - Generate Visual Prompts",
                      "type":  "n8n-nodes-base.openAi",
                      "typeVersion":  1,
                      "position":  [
                                       3450,
                                       500
                                   ],
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "openai-api-credentials",
                                                            "name":  "OpenAI API"
        }
      }
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Parsear la respuesta de OpenAI\nconst response = $input.item.json;\nlet visualPrompts = {};\n\ntry {\n  let content = response.choices?.[0]?.message?.content || response.message?.content || \u0027\u0027;\n  content = content.trim();\n  if (content.startsWith(\u0027```json\u0027)) {\n    content = content.replace(/```json\\s*/g, \u0027\u0027).replace(/```\\s*/g, \u0027\u0027);\n  } else if (content.startsWith(\u0027```\u0027)) {\n    content = content.replace(/```\\s*/g, \u0027\u0027);\n  }\n  visualPrompts = JSON.parse(content);\n} catch (error) {\n  try {\n    const jsonMatch = response.choices?.[0]?.message?.content?.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      visualPrompts = JSON.parse(jsonMatch[0]);\n    } else {\n      const strategy = $(\u0027Parse Copy\u0027).item.json.strategy || {};\n      const copy = $(\u0027Parse Copy\u0027).item.json.copy || {};\n      const mainMessage = strategy.mainMessage || copy.longCopy || \u0027Producto de marketing\u0027;\n      visualPrompts = {\n        imagePrompt: `High-quality marketing image: ${mainMessage}. Professional photography style, vibrant colors, modern composition, natural lighting, engaging and attractive visual, optimized for social media, ${strategy.tone || \u0027professional\u0027} tone`,\n        videoPrompt: `Marketing video: ${mainMessage}. Smooth camera movements, dynamic transitions, professional cinematography, vibrant colors, engaging visual storytelling, ${strategy.tone || \u0027professional\u0027} aesthetic, optimized for social media`,\n        imageStyle: strategy.tone === \u0027casual\u0027 ? \u0027vibrant\u0027 : \u0027professional\u0027,\n        colorPalette: [\u0027vibrant\u0027, \u0027modern\u0027],\n        mood: strategy.tone || \u0027professional\u0027,\n        aspectRatio: strategy.recommendedFormat === \u0027story\u0027 ? \u00279:16\u0027 : strategy.recommendedFormat === \u0027reel\u0027 ? \u00279:16\u0027 : \u00271:1\u0027,\n        technicalSpecs: { resolution: \u0027high\u0027, quality: \u0027professional\u0027, lighting: \u0027natural\u0027, composition: \u0027balanced\u0027 }\n      };\n    }\n  } catch (parseError) {\n    const strategy = $(\u0027Parse Copy\u0027).item.json.strategy || {};\n    visualPrompts = {\n      imagePrompt: \u0027High-quality marketing image, professional style, vibrant colors\u0027,\n      videoPrompt: \u0027Marketing video, professional cinematography, engaging visuals\u0027,\n      imageStyle: \u0027professional\u0027,\n      colorPalette: [],\n      mood: \u0027professional\u0027,\n      aspectRatio: \u00271:1\u0027,\n      technicalSpecs: { resolution: \u0027high\u0027, quality: \u0027professional\u0027, lighting: \u0027natural\u0027, composition: \u0027balanced\u0027 }\n    };\n  }\n}\n\nconst finalPrompts = {\n  imagePrompt: visualPrompts.imagePrompt || \u0027High-quality marketing image, professional style\u0027,\n  videoPrompt: visualPrompts.videoPrompt || \u0027Marketing video, professional cinematography\u0027,\n  imageStyle: visualPrompts.imageStyle || \u0027professional\u0027,\n  colorPalette: Array.isArray(visualPrompts.colorPalette) ? visualPrompts.colorPalette : [],\n  mood: visualPrompts.mood || \u0027professional\u0027,\n  aspectRatio: visualPrompts.aspectRatio || \u00271:1\u0027,\n  technicalSpecs: {\n    resolution: visualPrompts.technicalSpecs?.resolution || \u0027high\u0027,\n    quality: visualPrompts.technicalSpecs?.quality || \u0027professional\u0027,\n    lighting: visualPrompts.technicalSpecs?.lighting || \u0027natural\u0027,\n    composition: visualPrompts.technicalSpecs?.composition || \u0027balanced\u0027\n  }\n};\n\nconst strategy = $(\u0027Parse Copy\u0027).item.json.strategy || {};\nconst metadata = {\n  tenantId: $(\u0027Parse Copy\u0027).item.json.tenantId || \u0027\u0027,\n  generatedAt: new Date().toISOString(),\n  format: strategy.recommendedFormat || \u0027post\u0027,\n  channels: strategy.channels || [],\n  tone: strategy.tone || \u0027professional\u0027\n};\n\nreturn {\n  ...$(\u0027Parse Copy\u0027).item.json,\n  visualPrompts: { ...finalPrompts, metadata }\n};"
      },
                      "id":  "parse-visual-prompts",
                      "name":  "Parse Visual Prompts",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       3650,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Motor de Decisiones Cognitivo - Calcula confidenceScore y ajusta decisiones\nconst components = $input.item.json;\nconst strategy = components.strategy || {};\nconst copy = components.copy || {};\nconst visualPrompts = components.visualPrompts || {};\nconst advancedMemory = components.advancedMemory || {};\nconst confidenceWeights = components.confidenceWeights || {};\nconst analysis = components.analysis || {};\n\n// Calcular confidenceScore base (0-1)\nlet confidenceScore = 0.5; // Base\nlet decisionRationale = [];\nlet learningSources = [];\n\n// Factor 1: Canales con mejor performance (30%)\n// AUTO-AJUSTE: Penaliza canales con bajo rendimiento histórico y refuerza los exitosos\nconst selectedChannels = Array.isArray(strategy.channels) ? strategy.channels : [];\nconst performanceMemory = advancedMemory.performanceMemory || {};\nconst channelKPIs = performanceMemory.channelKPIs || {};\n\n// Ajustar confidenceWeights basado en resultados históricos\nconst adjustedChannelWeights = {};\nselectedChannels.forEach(channel =\u003e {\n  const baseWeight = confidenceWeights.channel?.[channel.toLowerCase()] || 0.5;\n  const kpi = channelKPIs[channel.toLowerCase()] || {};\n  const ctr = kpi.ctr || 0;\n  const engagement = kpi.engagement || 0;\n  \n  // Ajuste automático: refuerza si tiene buen CTR/engagement, penaliza si no\n  let adjustment = 0;\n  if (ctr \u003e 0.02) adjustment += 0.1; // CTR \u003e 2% es bueno\n  if (ctr \u003c 0.005) adjustment -= 0.15; // CTR \u003c 0.5% es malo\n  if (engagement \u003e 0.05) adjustment += 0.1; // Engagement \u003e 5% es bueno\n  if (engagement \u003c 0.01) adjustment -= 0.15; // Engagement \u003c 1% es malo\n  \n  adjustedChannelWeights[channel.toLowerCase()] = Math.max(0.1, Math.min(0.9, baseWeight + adjustment));\n});\n\nconst channelConfidence = selectedChannels.reduce((acc, channel) =\u003e {\n  const weight = adjustedChannelWeights[channel.toLowerCase()] || 0.5;\n  return acc + weight;\n}, 0) / Math.max(selectedChannels.length, 1);\nconfidenceScore += channelConfidence * 0.3;\nif (channelConfidence \u003e 0.6) {\n  decisionRationale.push(`Canales seleccionados tienen alta performance histórica (${(channelConfidence * 100).toFixed(0)}%)`);\n  learningSources.push(\u0027PerformanceMemory\u0027);\n}\n\n// Factor 2: Formato apropiado para urgencia (20%)\nconst urgency = analysis.urgency || \u0027medium\u0027;\nconst format = strategy.recommendedFormat || \u0027post\u0027;\nconst formatKey = `${urgency}_${format}`;\nconst formatConfidence = confidenceWeights.format?.[formatKey] || confidenceWeights.format?.[format] || 0.5;\nconfidenceScore += formatConfidence * 0.2;\nif (formatConfidence \u003e 0.6) {\n  decisionRationale.push(`Formato ${format} es exitoso para urgencia ${urgency} (${(formatConfidence * 100).toFixed(0)}%)`);\n  learningSources.push(\u0027PatternMemory\u0027);\n}\n\n// Factor 3: Tono con mayor engagement (20%)\nconst tone = strategy.tone || \u0027profesional\u0027;\nconst toneConfidence = confidenceWeights.tone?.[tone] || 0.5;\nconfidenceScore += toneConfidence * 0.2;\nif (toneConfidence \u003e 0.6) {\n  decisionRationale.push(`Tono ${tone} tiene alto engagement histórico (${(toneConfidence * 100).toFixed(0)}%)`);\n  learningSources.push(\u0027PerformanceMemory\u0027);\n}\n\n// Factor 4: Evitar patrones fallidos (15%)\n// AUTO-AJUSTE: Penaliza automáticamente patrones fallidos y refuerza exitosos\nconst avoidPatterns = components.avoidPatterns || [];\nconst patternMemory = advancedMemory.patternMemory || {};\nconst successfulPatterns = patternMemory.successfulPatterns || [];\nconst blockedPatterns = patternMemory.blockedPatterns || [];\nlet patternViolations = 0;\nconst currentPattern = `${urgency}_${format}_${tone}`;\nconst isBlocked = blockedPatterns.some(blocked =\u003e currentPattern.includes(blocked) || blocked.includes(currentPattern));\n\nif (isBlocked) {\n  patternViolations = 1;\n  confidenceScore = 0; // Bloqueo total si está en lista de bloqueados\n  decisionRationale.push(`BLOQUEO: Patrón bloqueado temporalmente por fallos repetidos (30 días)`);\n  learningSources.push(\u0027PatternMemory\u0027);\n} else if (avoidPatterns.some(pattern =\u003e currentPattern.includes(pattern) || pattern.includes(currentPattern))) {\n  patternViolations = 1;\n  confidenceScore -= 0.2; // Penalización aumentada para patrones fallidos\n  decisionRationale.push(`ADVERTENCIA: Patrón similar a uno que ha fallado históricamente - PENALIZADO`);\n} else if (successfulPatterns.some(pattern =\u003e currentPattern.includes(pattern) || pattern.includes(currentPattern))) {\n  // Refuerzo para patrones exitosos\n  confidenceScore += 0.1;\n  decisionRationale.push(`Patrón identificado como exitoso históricamente - REFORZADO`);\n  learningSources.push(\u0027PatternMemory\u0027);\n} else {\n  confidenceScore += 0.05; // Patrón neutro\n  decisionRationale.push(`Patrón no está en lista de fallos históricos`);\n  learningSources.push(\u0027PatternMemory\u0027);\n}\n\n// Factor 5: Preferencias del tenant (10%)\nconst preferredFormats = components.preferredFormats || [];\nif (preferredFormats.includes(format)) {\n  confidenceScore += 0.1;\n  decisionRationale.push(`Formato ${format} está en preferencias del tenant`);\n  learningSources.push(\u0027PreferenceMemory\u0027);\n}\n\n// Factor 6: Restricciones cumplidas (5%)\nconst constraints = advancedMemory.constraintMemory?.restrictions || [];\nconst hasViolations = constraints.some(constraint =\u003e {\n  const channel = selectedChannels.find(c =\u003e constraint.toLowerCase().includes(c.toLowerCase()));\n  return channel !== undefined;\n});\nif (!hasViolations) {\n  confidenceScore += 0.05;\n  decisionRationale.push(`No se violan restricciones conocidas`);\n  learningSources.push(\u0027ConstraintMemory\u0027);\n} else {\n  confidenceScore -= 0.05;\n  decisionRationale.push(`ADVERTENCIA: Posible violación de restricciones`);\n}\n\n// Normalizar confidenceScore a 0-1\nconfidenceScore = Math.max(0, Math.min(1, confidenceScore));\n\n// Ajustar temperatura del modelo según confidence\n// Si confidence es bajo, usar temperatura más alta para más variación\n// Si confidence es alto, usar temperatura más baja para consistencia\nconst adaptiveTemperature = confidenceScore \u003c 0.6 ? 0.8 : (confidenceScore \u003e 0.8 ? 0.5 : 0.7);\n\n// Reducir variantes si confidence es bajo\nconst shouldReduceVariants = confidenceScore \u003c 0.6;\n\n// Obtener cognitiveVersion REAL desde último MarketingPack o memoria\n// Se incrementa automáticamente cuando hay cambios significativos\nconst lastCognitiveVersion = components.lastCognitiveVersion || 1;\nlet cognitiveVersion = lastCognitiveVersion;\n\n// Si hay patrones fallidos recientes o cambios en priorización, incrementar versión\nconst recentFailedPatterns = patternMemory.failedPatterns || [];\nconst hasRecentFailures = recentFailedPatterns.length \u003e 0;\nconst hasChannelPriorityChanges = performanceMemory.bestPerformingChannels \u0026\u0026 \n  performanceMemory.bestPerformingChannels.length \u003e 0 \u0026\u0026\n  !selectedChannels.every(c =\u003e performanceMemory.bestPerformingChannels.includes(c));\n\n// Verificar si hay patrones exitosos nuevos que cambien priorización\nconst hasSuccessfulPatterns = successfulPatterns.length \u003e 0 \u0026\u0026 \n  !successfulPatterns.every(sp =\u003e {\n    const patternStr = typeof sp === \u0027string\u0027 ? sp : (sp.pattern || JSON.stringify(sp));\n    return currentPattern.includes(patternStr) || patternStr.includes(currentPattern);\n  });\r\n\r\n// Incrementar versión cuando hay aprendizaje significativo\nif (hasRecentFailures || hasChannelPriorityChanges || hasSuccessfulPatterns || patternViolations \u003e 0) {\n  cognitiveVersion = lastCognitiveVersion + 1;\n}\n\n// Decision rationale completo\nconst fullRationale = decisionRationale.join(\u0027; \u0027);\n\n// Learning sources únicos\nconst uniqueLearningSources = [...new Set(learningSources)];\n\nreturn {\n  ...components,\n  cognitiveDecision: {\n    confidenceScore: confidenceScore,\n    adaptiveTemperature: adaptiveTemperature,\n    shouldReduceVariants: shouldReduceVariants,\n    decisionRationale: fullRationale,\n    learningSources: uniqueLearningSources,\n    cognitiveVersion: cognitiveVersion,\n    channelConfidence: channelConfidence,\n    formatConfidence: formatConfidence,\n    toneConfidence: toneConfidence,\n    patternViolations: patternViolations,\n    calculatedAt: ($(\u0027Set Validated Data\u0027).item?.json?.validatedData?.receivedAt || new Date().toISOString())\n  }\n};"
      },
                      "id":  "cognitive-decision-engine",
                      "name":  "Cognitive Decision Engine",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       3850,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Ensamblar el MarketingPack completo con campos cognitivos\nconst components = $input.item.json;\nconst strategy = components.strategy || {};\nconst copy = components.copy || {};\nconst visualPrompts = components.visualPrompts || {};\nconst media = Array.isArray(components.assets) ? components.assets : [];\nconst channels = Array.isArray(components.channels) ? components.channels : (strategy.channels || []);\n\n// Generar ID único para el pack\nconst packId = require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \n  \u0027xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\u0027.replace(/[xy]/g, function(c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === \u0027x\u0027 ? r : (r \u0026 0x3 | 0x8);\n    return v.toString(16);\n  });\n\n// Construir la estrategia como texto estructurado\nconst strategyText = JSON.stringify({\n  mainMessage: strategy.mainMessage || \u0027\u0027,\n  cta: strategy.cta || \u0027\u0027,\n  recommendedFormat: strategy.recommendedFormat || \u0027post\u0027,\n  tone: strategy.tone || \u0027profesional\u0027,\n  targetAudience: strategy.targetAudience || \u0027\u0027,\n  keyPoints: strategy.keyPoints || [],\n  suggestedSchedule: strategy.suggestedSchedule || {},\n  contentStructure: strategy.contentStructure || {}\n}, null, 2);\n\n// Construir metadatos completos\nconst metadata = {\n  tenantId: components.tenantId || \u0027\u0027,\n  userId: components.userId || \u0027\u0027,\n  campaignId: components.campaignId || null,\n  contentId: \u0027\u0027,\n  channels: channels,\n  requiresApproval: components.requiresApproval !== undefined ? components.requiresApproval : true,\n  generatedAt: new Date().toISOString(),\n  version: 1,\n  strategy: strategy,\n  copy: copy,\n  visualPrompts: visualPrompts,\n  media: media\n};\n\n// Construir GeneratedCopies desde el copy\nconst generatedCopies = [];\n\nif (copy.longCopy) {\n  generatedCopies.push({\n    id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027copy-\u0027 + Date.now(),\n    copyType: \u0027long\u0027,\n    content: copy.longCopy,\n    hashtags: copy.hashtags ? copy.hashtags.join(\u0027, \u0027) : null,\n    suggestedChannel: channels.length \u003e 0 ? channels[0] : null,\n    publicationChecklist: {\n      hasCopy: true,\n      hasHashtags: (copy.hashtags || []).length \u003e 0,\n      hasMedia: media.length \u003e 0,\n      readyForPublication: true\n    }\n  });\n}\n\nif (copy.shortCopy) {\n  generatedCopies.push({\n    id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027copy-short-\u0027 + Date.now(),\n    copyType: \u0027short\u0027,\n    content: copy.shortCopy,\n    hashtags: copy.hashtags ? copy.hashtags.join(\u0027, \u0027) : null,\n    suggestedChannel: channels.length \u003e 0 ? channels[0] : null,\n    publicationChecklist: {\n      hasCopy: true,\n      hasHashtags: (copy.hashtags || []).length \u003e 0,\n      hasMedia: media.length \u003e 0,\n      readyForPublication: true\n    }\n  });\n}\n\nif (copy.variants) {\n  if (copy.variants.variantA) {\n    generatedCopies.push({\n      id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027copy-var-a-\u0027 + Date.now(),\n      copyType: \u0027variant-a\u0027,\n      content: copy.variants.variantA.longCopy || copy.variants.variantA.shortCopy || \u0027\u0027,\n      hashtags: copy.variants.variantA.hashtags ? copy.variants.variantA.hashtags.join(\u0027, \u0027) : null,\n      suggestedChannel: channels.length \u003e 0 ? channels[0] : null,\n      publicationChecklist: {\n        hasCopy: true,\n        hasHashtags: (copy.variants.variantA.hashtags || []).length \u003e 0,\n        isVariant: true,\n        variantType: \u0027A\u0027\n      }\n    });\n  }\n  \n  if (copy.variants.variantB) {\n    generatedCopies.push({\n      id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027copy-var-b-\u0027 + Date.now(),\n      copyType: \u0027variant-b\u0027,\n      content: copy.variants.variantB.longCopy || copy.variants.variantB.shortCopy || \u0027\u0027,\n      hashtags: copy.variants.variantB.hashtags ? copy.variants.variantB.hashtags.join(\u0027, \u0027) : null,\n      suggestedChannel: channels.length \u003e 0 ? channels[0] : null,\n      publicationChecklist: {\n        hasCopy: true,\n        hasHashtags: (copy.variants.variantB.hashtags || []).length \u003e 0,\n        isVariant: true,\n        variantType: \u0027B\u0027\n      }\n    });\n  }\n}\n\n// Construir MarketingAssetPrompts desde visualPrompts\nconst assetPrompts = [];\n\nif (visualPrompts.imagePrompt) {\n  assetPrompts.push({\n    id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027prompt-img-\u0027 + Date.now(),\n    assetType: \u0027image\u0027,\n    prompt: visualPrompts.imagePrompt,\n    negativePrompt: null,\n    parameters: {\n      style: visualPrompts.imageStyle || \u0027professional\u0027,\n      aspectRatio: visualPrompts.aspectRatio || \u00271:1\u0027,\n      colorPalette: visualPrompts.colorPalette || [],\n      mood: visualPrompts.mood || \u0027professional\u0027,\n      ...(visualPrompts.technicalSpecs || {})\n    },\n    suggestedChannel: channels.length \u003e 0 ? channels[0] : null\n  });\n}\n\nif (visualPrompts.videoPrompt) {\n  assetPrompts.push({\n    id: require(\u0027crypto\u0027).randomUUID ? require(\u0027crypto\u0027).randomUUID() : \u0027prompt-vid-\u0027 + Date.now(),\n    assetType: \u0027video\u0027,\n    prompt: visualPrompts.videoPrompt,\n    negativePrompt: null,\n    parameters: {\n      aspectRatio: visualPrompts.aspectRatio || \u002716:9\u0027,\n      colorPalette: visualPrompts.colorPalette || [],\n      mood: visualPrompts.mood || \u0027professional\u0027,\n      ...(visualPrompts.technicalSpecs || {})\n    },\n    suggestedChannel: channels.length \u003e 0 ? channels[0] : null\n  });\n}\n\n// Obtener datos cognitivos del Decision Engine\nconst cognitiveDecision = components.cognitiveDecision || {};\nconst confidenceScore = cognitiveDecision.confidenceScore || 0.5;\nconst cognitiveVersion = cognitiveDecision.cognitiveVersion || 1;\nconst decisionRationale = cognitiveDecision.decisionRationale || \u0027\u0027;\nconst learningSources = cognitiveDecision.learningSources || [];\n\n// Construir el MarketingPack final con campos cognitivos\nconst marketingPack = {\n  id: packId,\n  tenantId: components.tenantId || \u0027\u0027,\n  userId: components.userId || \u0027\u0027,\n  contentId: \u0027\u0027,\n  campaignId: components.campaignId || null,\n  strategy: strategyText,\n  status: components.requiresApproval ? \u0027Generated\u0027 : \u0027Ready\u0027,\n  version: 1,\n  metadata: JSON.stringify(metadata),\n  copies: generatedCopies,\n  assetPrompts: assetPrompts,\n  channels: channels,\n  media: media,\n  requiresApproval: components.requiresApproval !== undefined ? components.requiresApproval : true,\n  createdAt: new Date().toISOString(),\n  // Campos cognitivos\n  cognitiveVersion: cognitiveVersion,\n  confidenceScore: confidenceScore,\n  learningSources: learningSources,\n  decisionRationale: decisionRationale\n};\n\nreturn {\n  ...components,\n  marketingPack: marketingPack,\n  cognitiveDecision: cognitiveDecision\n};"
      },
                      "id":  "build-pack",
                      "name":  "Build Marketing Pack",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       3850,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.marketingPack.confidenceScore ?? $json.cognitiveDecision?.confidenceScore ?? 0.5 }}",
                                                                                   "rightValue":  0.6,
                                                                                   "operator":  {
                                                                                                    "type":  "number",
                                                                                                    "operation":  "smaller"
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "validate-confidence-score",
                      "name":  "Validate Confidence Score",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       4050,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Registrar Override Humano cuando confidenceScore \u003c 0.6 pero requiresApproval = false\nconst components = $input.item.json;\nconst marketingPack = components.marketingPack || {};\nconst cognitiveDecision = components.cognitiveDecision || {};\nconst strategy = components.strategy || {};\nconst validatedData = $(\u0027Set Validated Data\u0027).item?.json?.validatedData || {};\n\nconst confidenceScore = marketingPack.confidenceScore ?? cognitiveDecision?.confidenceScore ?? 0.5;\nconst requiresApproval = marketingPack.requiresApproval ?? components.requiresApproval ?? true;\n\n// Detectar override: confidenceScore \u003c 0.6 pero requiresApproval = false\nconst isOverride = confidenceScore \u003c 0.6 \u0026\u0026 requiresApproval === false;\n\nif (isOverride) {\n  // Extraer datos del patrón\n  const urgency = components.analysis?.urgency || \u0027medium\u0027;\n  const format = strategy.recommendedFormat || \u0027post\u0027;\n  const tone = strategy.tone || \u0027profesional\u0027;\n  const channels = Array.isArray(strategy.channels) ? strategy.channels : [];\n  const pattern = `${urgency}_${format}_${tone}`;\n  \n  // Obtener overrideReason del payload si existe\n  const overrideReason = components.overrideReason || components.overrideSource || \u0027unknown\u0027;\n  const overrideSource = components.overrideSource || \u0027unknown\u0027;\n  \n  // Usar timestamp determinístico del validatedData\n  const timestamp = validatedData.receivedAt || new Date().toISOString();\n  const requestId = validatedData.requestId || \u0027unknown\u0027;\n  \n  // Crear overrideData estructurado\n  const overrideData = {\n    pattern: pattern,\n    result: \u0027override\u0027,\n    overrideType: \u0027human_forced_publication\u0027,\n    originalConfidenceScore: Math.round(confidenceScore * 10000) / 10000,\n    humanDecision: \u0027force_publication\u0027,\n    overrideReason: overrideReason,\n    overrideSource: overrideSource,\n    context: {\n      channels: channels,\n      format: format,\n      tone: tone,\n      urgency: urgency,\n      campaignId: components.campaignId || null,\n      marketingPackId: marketingPack.id || null\n    },\n    timestamp: timestamp,\n    requestId: requestId,\n    userId: components.userId || validatedData.userId || \u0027unknown\u0027,\n    decisionRationale: cognitiveDecision.decisionRationale || \u0027\u0027\n  };\n  \n  return {\n    ...components,\n    humanOverride: overrideData,\n    hasOverride: true\n  };\n}\n\n// Sin override, pasar datos sin cambios\nreturn {\n  ...components,\n  hasOverride: false\n};"
      },
                      "id":  "register-human-override",
                      "name":  "Register Human Override",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       4250,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/MemoryApi/save",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ $json.humanOverride ? { \"tenantId\": $json.tenantId, \"campaignId\": $json.campaignId, \"memoryType\": \u0027Pattern\u0027, \"content\": JSON.stringify($json.humanOverride), \"context\": $json.humanOverride.context, \"tags\": [\u0027override\u0027, \u0027human-decision\u0027, \u0027pattern\u0027], \"relevanceScore\": 9, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } : {} }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-override-memory",
                      "name":  "HTTP Request - Save Override Memory",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4450,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.marketingPack.confidenceScore ?? $json.cognitiveDecision?.confidenceScore ?? 0.5 }}",
                                                                                   "rightValue":  0.6,
                                                                                   "operator":  {
                                                                                                    "type":  "number",
                                                                                                    "operation":  "smaller"
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "check-approval-final",
                      "name":  "Check Requires Approval Final",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       4250,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/marketing-packs",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"id\": $json.marketingPack.id || null, \"tenantId\": $json.marketingPack.tenantId, \"userId\": $json.marketingPack.userId, \"contentId\": $json.marketingPack.contentId, \"campaignId\": $json.marketingPack.campaignId || null, \"strategy\": $json.marketingPack.strategy, \"status\": \"RequiresApproval\", \"version\": $json.marketingPack.version || 1, \"metadata\": $json.marketingPack.metadata, \"copies\": $json.marketingPack.copies || [], \"assetPrompts\": $json.marketingPack.assetPrompts || [], \"cognitiveVersion\": $json.marketingPack.cognitiveVersion || 1, \"confidenceScore\": $json.marketingPack.confidenceScore || 0.5, \"learningSources\": $json.marketingPack.learningSources || [], \"decisionRationale\": $json.marketingPack.decisionRationale || \u0027\u0027, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-pack-approval",
                      "name":  "HTTP Request - Save Pack (Requires Approval)",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4250,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "respondWith":  "json",
                                         "responseBody":  "={{ { success: true, message: \u0027Marketing pack sent for approval\u0027, data: { packId: $json.id || $(\u0027HTTP Request - Save Pack (Requires Approval)\u0027).item.json.id, status: \u0027RequiresApproval\u0027, requiresApproval: true, message: \u0027Pack has been saved and is waiting for human approval\u0027, nextStep: \u0027approval\u0027 } } }}",
                                         "options":  {
                                                         "responseCode":  200
        }
      },
                      "id":  "respond-approval-required",
                      "name":  "Respond - Approval Required",
                      "type":  "n8n-nodes-base.respondToWebhook",
                      "typeVersion":  1,
                      "position":  [
                                       4450,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/marketing-packs",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"id\": $json.marketingPack.id || null, \"tenantId\": $json.marketingPack.tenantId, \"userId\": $json.marketingPack.userId, \"contentId\": $json.marketingPack.contentId, \"campaignId\": $json.marketingPack.campaignId || null, \"strategy\": $json.marketingPack.strategy, \"status\": \"Ready\", \"version\": $json.marketingPack.version || 1, \"metadata\": $json.marketingPack.metadata, \"copies\": $json.marketingPack.copies || [], \"assetPrompts\": $json.marketingPack.assetPrompts || [], \"cognitiveVersion\": $json.marketingPack.cognitiveVersion || 1, \"confidenceScore\": $json.marketingPack.confidenceScore || 0.5, \"learningSources\": $json.marketingPack.learningSources || [], \"decisionRationale\": $json.marketingPack.decisionRationale || \u0027\u0027, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-pack-ready",
                      "name":  "HTTP Request - Save Pack (Ready)",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4250,
                                       600
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Preparar datos para publicación en cada canal\nconst marketingPack = $input.item.json.marketingPack;\nconst copy = $input.item.json.copy || {};\nconst channels = Array.isArray(marketingPack.channels) ? marketingPack.channels : [];\nconst publishJobs = [];\n\n// Para cada canal, crear un job de publicación\nchannels.forEach(channel =\u003e {\n  const channelCopy = copy.publishFormat?.[channel.toLowerCase()] || copy.longCopy || \u0027\u0027;\n  const hashtags = copy.hashtags || [];\n  const hashtagsString = hashtags.map(h =\u003e \u0027#\u0027 + h.replace(/^#/, \u0027\u0027)).join(\u0027 \u0027);\n  \n  publishJobs.push({\n    channel: channel.toLowerCase(),\n    content: channelCopy,\n    hashtags: hashtagsString,\n    mediaUrl: marketingPack.media \u0026\u0026 marketingPack.media.length \u003e 0 ? marketingPack.media[0] : null,\n    tenantId: marketingPack.tenantId,\n    campaignId: marketingPack.campaignId,\n    marketingPackId: marketingPack.id,\n    generatedCopyId: marketingPack.copies \u0026\u0026 marketingPack.copies.length \u003e 0 ? marketingPack.copies[0].id : null\n  });\n});\n\nreturn publishJobs.map(job =\u003e ({ json: { ...$input.item.json, ...job } }));"
      },
                      "id":  "prepare-publish-jobs",
                      "name":  "Prepare Publish Jobs",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       4450,
                                       600
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  false,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.channel.toLowerCase() }}",
                                                                                   "rightValue":  "instagram",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "equals"
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "check-instagram",
                      "name":  "Check - Instagram",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       4650,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  false,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.channel.toLowerCase() }}",
                                                                                   "rightValue":  "facebook",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "equals"
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "check-facebook",
                      "name":  "Check - Facebook",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       4650,
                                       600
                                   ]
    },
    {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  false,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
          },
                                                            "conditions":  [
            {
                                                                                   "leftValue":  "={{ $json.channel.toLowerCase() }}",
                                                                                   "rightValue":  "tiktok",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "equals"
              }
            }
          ],
                                                            "combinator":  "and"
        },
                                         "options":  {

                                                     }
      },
                      "id":  "check-tiktok",
                      "name":  "Check - TikTok",
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2,
                      "position":  [
                                       4650,
                                       700
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.INSTAGRAM_API_URL || \u0027https://api.instagram.com/v1/media\u0027 }}",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"caption\": ($json.content || \u0027\u0027) + \u0027 \u0027 + ($json.hashtags || \u0027\u0027), \"image_url\": $json.mediaUrl || \u0027\u0027, \"access_token\": $env.INSTAGRAM_ACCESS_TOKEN || \u0027simulated_token\u0027 } }}",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
            {
                                                                                         "name":  "X-Publish-Data",
                                                                                         "value":  "={{ JSON.stringify({ channel: $json.channel, content: $json.content, hashtags: $json.hashtags, mediaUrl: $json.mediaUrl, tenantId: $json.tenantId, campaignId: $json.campaignId, marketingPackId: $json.marketingPackId, generatedCopyId: $json.generatedCopyId }) }}"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  30000
        }
      },
                      "id":  "publish-instagram",
                      "name":  "Publish - Instagram",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4850,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.FACEBOOK_API_URL || \u0027https://graph.facebook.com/v18.0/me/feed\u0027 }}",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"message\": ($json.content || \u0027\u0027) + \u0027 \u0027 + ($json.hashtags || \u0027\u0027), \"link\": $json.mediaUrl || \u0027\u0027, \"access_token\": $env.FACEBOOK_ACCESS_TOKEN || \u0027simulated_token\u0027 } }}",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
            {
                                                                                         "name":  "X-Publish-Data",
                                                                                         "value":  "={{ JSON.stringify({ channel: $json.channel, content: $json.content, hashtags: $json.hashtags, mediaUrl: $json.mediaUrl, tenantId: $json.tenantId, campaignId: $json.campaignId, marketingPackId: $json.marketingPackId, generatedCopyId: $json.generatedCopyId }) }}"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  30000
        }
      },
                      "id":  "publish-facebook",
                      "name":  "Publish - Facebook",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4850,
                                       600
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $env.TIKTOK_API_URL || \u0027https://open-api.tiktok.com/video/upload\u0027 }}",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"caption\": ($json.content || \u0027\u0027) + \u0027 \u0027 + ($json.hashtags || \u0027\u0027), \"video_url\": $json.mediaUrl || \u0027\u0027, \"access_token\": $env.TIKTOK_ACCESS_TOKEN || \u0027simulated_token\u0027 } }}",
                                         "sendHeaders":  true,
                                         "headerParameters":  {
                                                                  "parameters":  [
            {
                                                                                         "name":  "X-Publish-Data",
                                                                                         "value":  "={{ JSON.stringify({ channel: $json.channel, content: $json.content, hashtags: $json.hashtags, mediaUrl: $json.mediaUrl, tenantId: $json.tenantId, campaignId: $json.campaignId, marketingPackId: $json.marketingPackId, generatedCopyId: $json.generatedCopyId }) }}"
            }
          ]
        },
                                         "options":  {
                                                         "timeout":  30000
        }
      },
                      "id":  "publish-tiktok",
                      "name":  "Publish - TikTok",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       4850,
                                       700
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Procesar resultado de publicación (real o simulado)\nconst input = $input.item.json;\n// Intentar obtener datos del item anterior usando el contexto de n8n\nlet publishData = {};\ntry {\n  // Intentar obtener del nodo anterior (Prepare Publish Jobs)\n  const previousNode = $(\u0027Prepare Publish Jobs\u0027);\n  if (previousNode \u0026\u0026 previousNode.item) {\n    publishData = previousNode.item.json;\n  }\n} catch (e) {\n  // Si falla, usar datos del input actual\n  publishData = input;\n}\n\n// Si el input tiene los datos directamente (viene de Check - Instagram/Facebook/TikTok cuando no coincide)\nconst channel = input.channel || publishData.channel || \u0027\u0027;\nconst content = input.content || publishData.content || \u0027\u0027;\nconst hashtags = input.hashtags || publishData.hashtags || \u0027\u0027;\nconst mediaUrl = input.mediaUrl || publishData.mediaUrl || null;\nconst tenantId = input.tenantId || publishData.tenantId || \u0027\u0027;\nconst campaignId = input.campaignId || publishData.campaignId || null;\nconst marketingPackId = input.marketingPackId || publishData.marketingPackId || null;\nconst generatedCopyId = input.generatedCopyId || publishData.generatedCopyId || null;\n\nconst isSimulated = !input.id \u0026\u0026 !input.post_id \u0026\u0026 !input.data \u0026\u0026 !input.success;\nconst hasError = input.error || input.error_code || (input.statusCode \u0026\u0026 input.statusCode \u003e= 400);\n\nif (hasError || isSimulated) {\n  const simulatedResponse = {\n    success: true,\n    simulated: true,\n    channel: channel.toLowerCase(),\n    postId: `sim_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    publishedUrl: `https://${channel.toLowerCase()}.com/posts/sim_${Date.now()}`,\n    publishedAt: new Date().toISOString(),\n    message: `Publication simulated for ${channel} (no credentials configured)`,\n    content: content,\n    hashtags: hashtags,\n    mediaUrl: mediaUrl,\n    tenantId: tenantId,\n    campaignId: campaignId,\n    marketingPackId: marketingPackId,\n    generatedCopyId: generatedCopyId\n  };\n  \n  return simulatedResponse;\n} else {\n  const realResponse = {\n    success: true,\n    simulated: false,\n    channel: channel.toLowerCase(),\n    postId: input.id || input.post_id || input.data?.id || `real_${Date.now()}`,\n    publishedUrl: input.permalink_url || input.link || input.data?.url || `https://${channel.toLowerCase()}.com/posts/${input.id || input.post_id}`,\n    publishedAt: new Date().toISOString(),\n    message: `Successfully published to ${channel}`,\n    content: content,\n    hashtags: hashtags,\n    mediaUrl: mediaUrl,\n    tenantId: tenantId,\n    campaignId: campaignId,\n    marketingPackId: marketingPackId,\n    generatedCopyId: generatedCopyId\n  };\n  \n  return realResponse;\n}"
      },
                      "id":  "process-publish-result",
                      "name":  "Process Publish Result",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       5050,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/publishing-jobs",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"tenantId\": $json.tenantId, \"campaignId\": $json.campaignId, \"marketingPackId\": $json.marketingPackId || null, \"generatedCopyId\": $json.generatedCopyId || null, \"channel\": $json.channel, \"status\": $json.success ? \u0027Success\u0027 : \u0027Failed\u0027, \"publishedDate\": $json.publishedAt || new Date().toISOString(), \"publishedUrl\": $json.publishedUrl || null, \"externalPostId\": $json.postId || null, \"content\": $json.content, \"hashtags\": $json.hashtags, \"mediaUrl\": $json.mediaUrl || null, \"errorMessage\": $json.success ? null : ($json.error || $json.message || \u0027Unknown error\u0027), \"metadata\": JSON.stringify({ \"simulated\": $json.simulated || false, \"channel\": $json.channel, \"publishedAt\": $json.publishedAt }), \"scheduledDate\": null, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-publishing-job",
                      "name":  "HTTP Request - Save Publishing Job",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       5250,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Consolidar todos los resultados de publicación\nconst allResults = $input.all();\nconst firstResult = allResults[0] || {};\n\n// Obtener todos los publishing jobs guardados (vienen del HTTP Request - Save Publishing Job)\nconst publishingJobs = allResults\n  .filter(r =\u003e r.json.id \u0026\u0026 (r.json.channel || r.json.tenantId))\n  .map(r =\u003e ({\n    id: r.json.id,\n    channel: r.json.channel || \u0027unknown\u0027,\n    status: r.json.status || \u0027Success\u0027,\n    publishedUrl: r.json.publishedUrl || null\n  }));\n\n// Si no hay jobs, intentar obtener datos del primer resultado\nconst tenantId = firstResult.json.tenantId || \u0027\u0027;\nconst campaignId = firstResult.json.campaignId || null;\nconst marketingPackId = firstResult.json.marketingPackId || null;\n\nreturn {\n  tenantId: tenantId,\n  campaignId: campaignId,\n  marketingPackId: marketingPackId,\n  publishingJobIds: publishingJobs.map(j =\u003e j.id).filter(id =\u003e id),\n  publishingJobs: publishingJobs,\n  channels: publishingJobs.map(j =\u003e j.channel).filter(c =\u003e c),\n  allPublished: publishingJobs.length \u003e 0 \u0026\u0026 publishingJobs.every(j =\u003e j.status === \u0027Success\u0027),\n  success: true\n};"
      },
                      "id":  "consolidate-publish-results",
                      "name":  "Consolidate Publish Results",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       5450,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/metrics/campaign",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"tenantId\": $json.tenantId, \"campaignId\": $json.campaignId, \"metricDate\": new Date().toISOString().split(\u0027T\u0027)[0], \"impressions\": 0, \"clicks\": 0, \"likes\": 0, \"comments\": 0, \"shares\": 0, \"source\": \u0027n8n\u0027, \"notes\": \u0027Initial metrics from automated publishing\u0027, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-campaign-metrics",
                      "name":  "HTTP Request - Save Campaign Metrics",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       5650,
                                       400
                                   ]
    },
    {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "https://autonomousmarketingplatform.onrender.com/api/metrics/publishing-job",
                                         "sendBody":  true,
                                         "contentType":  "json",
                                         "body":  "={{ { \"tenantId\": $json.tenantId, \"publishingJobId\": $json.publishingJobIds[0] || \u0027\u0027, \"metricDate\": new Date().toISOString().split(\u0027T\u0027)[0], \"impressions\": 0, \"clicks\": 0, \"likes\": 0, \"comments\": 0, \"shares\": 0, \"source\": \u0027n8n\u0027, \"notes\": \u0027Initial metrics from automated publishing\u0027, \"cognitiveEngineVersion\": $(\u0027Set Cognitive Engine Version\u0027).item.json.cognitiveEngineVersion } }}",
                                         "options":  {
                                                         "timeout":  10000
        }
      },
                      "id":  "http-save-job-metrics",
                      "name":  "HTTP Request - Save Job Metrics",
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       5650,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "jsCode":  "// Consolidar resultados finales\nconst results = $input.all();\nconst consolidateData = $(\u0027Consolidate Publish Results\u0027).item.json;\n\nconst metricsResult = results.find(r =\u003e r.json.id \u0026\u0026 r.json.campaignId) || null;\nconst jobMetricsResult = results.find(r =\u003e r.json.publishingJobId) || null;\n\nreturn {\n  tenantId: consolidateData.tenantId,\n  campaignId: consolidateData.campaignId,\n  marketingPackId: consolidateData.marketingPackId,\n  publishingJobIds: consolidateData.publishingJobIds,\n  publishingJobs: consolidateData.publishingJobs,\n  channels: consolidateData.channels,\n  metricsSaved: metricsResult !== null,\n  jobMetricsSaved: jobMetricsResult !== null,\n  metricsId: metricsResult?.json.id || null,\n  jobMetricsId: jobMetricsResult?.json.id || null,\n  success: true,\n  message: \u0027Complete marketing flow executed successfully\u0027\n};"
      },
                      "id":  "consolidate-final-results",
                      "name":  "Consolidate Final Results",
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       5850,
                                       500
                                   ]
    },
    {
                      "parameters":  {
                                         "respondWith":  "json",
                                         "responseBody":  "={{ { success: true, message: \u0027Complete marketing flow executed successfully\u0027, data: $json } }}",
                                         "options":  {
                                                         "responseCode":  200
        }
      },
                      "id":  "respond-final-success",
                      "name":  "Respond - Final Success",
                      "type":  "n8n-nodes-base.respondToWebhook",
                      "typeVersion":  1,
                      "position":  [
                                       6050,
                                       500
                                   ]
    }
  ],
    "connections":  {
                        "Webhook - Receive Request":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Normalize Payload",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
    },
                        "Normalize Payload":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Validate Required Fields",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
    },
                        "Validate Required Fields":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "Respond - Validation Error",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ],
                                                                      [
                                                                          {
                                                                              "node":  "Set Validated Data",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
      ]
    },
                        "Set Validated Data":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Set Cognitive Engine Version",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                                       },
                        "Set Cognitive Engine Version":  {
                                                              "main":  [
                                                                           [
                                                                               {
                                                                                   "node":  "HTTP Request - Check Consents",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ]
                                                                       ]
    },
                        "HTTP Request - Check Consents":  {
                                                              "main":  [
                                                                           [
                                                                               {
                                                                                   "node":  "Normalize Consents",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ]
                                                                       ]
    },
                        "Normalize Consents":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Validate Consents",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
    },
                        "Validate Consents":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Respond - Consent Error",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ],
                                                               [
                                                                   {
                                                                       "node":  "HTTP Request - Load Marketing Memory",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
      ]
    },
                        "HTTP Request - Load Marketing Memory":  {
                                                                     "main":  [
                                                                                  [
                                                                                      {
                                                                                          "node":  "Normalize Memory",
                                                                                          "type":  "main",
                                                                                          "index":  0
                                                                                      }
                                                                                  ]
                                                                              ]
    },
                        "Normalize Memory":  {
                                                 "main":  [
        [
                                                                  {
                                                                      "node":  "HTTP Request - Load Preference Memory",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "HTTP Request - Load Performance Memory",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "HTTP Request - Load Constraint Memory",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "HTTP Request - Load Pattern Memory",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "HTTP Request - Get Last Cognitive Version",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
        ]
      ]
    },
                        "HTTP Request - Load Preference Memory":  {
                                                                      "main":  [
                                                                                   [
                                                                                       {
                                                                                           "node":  "Consolidate Advanced Memory",
                                                                                           "type":  "main",
                                                                                           "index":  0
                                                                                       }
                                                                                   ]
                                                                               ]
    },
                        "HTTP Request - Load Performance Memory":  {
                                                                       "main":  [
                                                                                    [
                                                                                        {
                                                                                            "node":  "Consolidate Advanced Memory",
                                                                                            "type":  "main",
                                                                                            "index":  0
                                                                                        }
                                                                                    ]
                                                                                ]
    },
                        "HTTP Request - Load Constraint Memory":  {
                                                                      "main":  [
                                                                                   [
                                                                                       {
                                                                                           "node":  "Consolidate Advanced Memory",
                                                                                           "type":  "main",
                                                                                           "index":  0
                                                                                       }
                                                                                   ]
                                                                               ]
    },
                        "HTTP Request - Load Pattern Memory":  {
                                                                   "main":  [
                                                                                [
                                                                                    {
                                                                                        "node":  "Consolidate Advanced Memory",
                                                                                        "type":  "main",
                                                                                        "index":  0
                                                                                    }
                                                                                ]
                                                                            ]
    },
                        "HTTP Request - Get Last Cognitive Version":  {
                                                                          "main":  [
                                                                                       [
                                                                                           {
                                                                                               "node":  "Consolidate Advanced Memory",
                                                                                               "type":  "main",
                                                                                               "index":  0
                                                                                           }
                                                                                       ]
                                                                                   ]
    },
                        "Consolidate Advanced Memory":  {
                                                            "main":  [
                                                                         [
                                                                             {
                                                                                 "node":  "OpenAI - Analyze Instruction (Cognitive)",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
    },
                        "OpenAI - Analyze Instruction (Cognitive)":  {
                                                                         "main":  [
                                                                                      [
                                                                                          {
                                                                                              "node":  "Parse Analysis",
                                                                                              "type":  "main",
                                                                                              "index":  0
                                                                                          }
                                                                                      ]
                                                                                  ]
    },
                        "Parse Analysis":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "OpenAI - Generate Strategy",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
    },
                        "OpenAI - Generate Strategy":  {
                                                           "main":  [
                                                                        [
                                                                            {
                                                                                "node":  "Parse Strategy",
                                                                                "type":  "main",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
    },
                        "Parse Strategy":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "OpenAI - Generate Copy",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
    },
                        "OpenAI - Generate Copy":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Parse Copy",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
    },
                        "Parse Copy":  {
                                           "main":  [
                                                        [
                                                            {
                                                                "node":  "OpenAI - Generate Visual Prompts",
                                                                "type":  "main",
                                                                "index":  0
                                                            }
                                                        ]
                                                    ]
    },
                        "OpenAI - Generate Visual Prompts":  {
                                                                 "main":  [
                                                                              [
                                                                                  {
                                                                                      "node":  "Parse Visual Prompts",
                                                                                      "type":  "main",
                                                                                      "index":  0
                                                                                  }
                                                                              ]
                                                                          ]
    },
                        "Parse Visual Prompts":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Cognitive Decision Engine",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
    },
                        "Cognitive Decision Engine":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Build Marketing Pack",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
    },
                        "Build Marketing Pack":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Validate Confidence Score",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
    },
                        "Validate Confidence Score":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Register Human Override",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ],
                                                                       [
                                                                           {
                                                                               "node":  "Check Requires Approval Final",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
      ]
    },
                        "Register Human Override":  {
                                                        "main":  [
        [
                                                                         {
                                                                             "node":  "HTTP Request - Save Override Memory",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         },
                                                                         {
                                                                             "node":  "Check Requires Approval Final",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
        ]
      ]
    },
                        "HTTP Request - Save Override Memory":  {
                                                                    "main":  [
                                                                                 [
                                                                                     {
                                                                                         "node":  "Check Requires Approval Final",
                                                                                         "type":  "main",
                                                                                         "index":  0
                                                                                     }
                                                                                 ]
                                                                             ]
    },
                        "Check Requires Approval Final":  {
                                                              "main":  [
                                                                           [
                                                                               {
                                                                                   "node":  "HTTP Request - Save Pack (Requires Approval)",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ],
                                                                           [
                                                                               {
                                                                                   "node":  "HTTP Request - Save Pack (Ready)",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ]
      ]
    },
                        "HTTP Request - Save Pack (Requires Approval)":  {
                                                                             "main":  [
                                                                                          [
                                                                                              {
                                                                                                  "node":  "Respond - Approval Required",
                                                                                                  "type":  "main",
                                                                                                  "index":  0
                                                                                              }
                                                                                          ]
                                                                                      ]
    },
                        "HTTP Request - Save Pack (Ready)":  {
                                                                 "main":  [
                                                                              [
                                                                                  {
                                                                                      "node":  "Prepare Publish Jobs",
                                                                                      "type":  "main",
                                                                                      "index":  0
                                                                                  }
                                                                              ]
                                                                          ]
    },
                        "Prepare Publish Jobs":  {
                                                     "main":  [
        [
                                                                      {
                                                                          "node":  "Check - Instagram",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      },
                                                                      {
                                                                          "node":  "Check - Facebook",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      },
                                                                      {
                                                                          "node":  "Check - TikTok",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
        ]
      ]
    },
                        "Check - Instagram":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Publish - Instagram",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ],
                                                               [
                                                                   {
                                                                       "node":  "Process Publish Result",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
      ]
    },
                        "Check - Facebook":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Publish - Facebook",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ],
                                                              [
                                                                  {
                                                                      "node":  "Process Publish Result",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
      ]
    },
                        "Check - TikTok":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "Publish - TikTok",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ],
                                                            [
                                                                {
                                                                    "node":  "Process Publish Result",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
      ]
    },
                        "Publish - Instagram":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Process Publish Result",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
    },
                        "Publish - Facebook":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Process Publish Result",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
    },
                        "Publish - TikTok":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Process Publish Result",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
    },
                        "Process Publish Result":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "HTTP Request - Save Publishing Job",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
    },
                        "HTTP Request - Save Publishing Job":  {
                                                                   "main":  [
                                                                                [
                                                                                    {
                                                                                        "node":  "Consolidate Publish Results",
                                                                                        "type":  "main",
                                                                                        "index":  0
                                                                                    }
                                                                                ]
                                                                            ]
    },
                        "Consolidate Publish Results":  {
                                                            "main":  [
                                                                         [
                                                                             {
                                                                                 "node":  "HTTP Request - Save Campaign Metrics",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ],
                                                                         [
                                                                             {
                                                                                 "node":  "HTTP Request - Save Job Metrics",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ],
                                                                         [
                                                                             {
                                                                                 "node":  "HTTP Request - Save Learning",
                                                                                 "type":  "main",
                                                                                 "index":  0
                                                                             }
                                                                         ]
      ]
    },
                        "HTTP Request - Save Campaign Metrics":  {
                                                                     "main":  [
                                                                                  [
                                                                                      {
                                                                                          "node":  "Consolidate Final Results",
                                                                                          "type":  "main",
                                                                                          "index":  0
                                                                                      }
                                                                                  ]
                                                                              ]
    },
                        "HTTP Request - Save Job Metrics":  {
                                                                "main":  [
                                                                             [
                                                                                 {
                                                                                     "node":  "Consolidate Final Results",
                                                                                     "type":  "main",
                                                                                     "index":  0
                                                                                 }
                                                                             ]
                                                                         ]
    },
                        "Consolidate Final Results":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Respond - Final Success",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
      ]
    }
  },
    "pinData":  {

                },
    "settings":  {
                     "executionOrder":  "v1",
                     "saveDataErrorExecution":  "all",
                     "saveDataSuccessExecution":  "all",
                     "saveManualExecutions":  true,
                     "callerPolicy":  "workflowsFromSameOwner",
                     "errorWorkflow":  ""
  },
    "staticData":  null,
    "tags":  [
    {
                     "createdAt":  "2025-01-01T00:00:00.000Z",
                     "updatedAt":  "2025-01-01T00:00:00.000Z",
                     "id":  "marketing-automation",
                     "name":  "Marketing Automation"
    },
    {
                     "createdAt":  "2025-01-01T00:00:00.000Z",
                     "updatedAt":  "2025-01-01T00:00:00.000Z",
                     "id":  "complete-flow",
                     "name":  "Complete Flow"
    }
  ],
    "triggerCount":  0,
    "updatedAt":  "2025-01-01T00:00:00.000Z",
    "versionId":  "1",
    "meta":  {

             }
}